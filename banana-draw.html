<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç»˜å›¾å·¥ä½œå®¤ - AI Hub</title>
    <link rel="stylesheet" href="styles/home.css">
    <style>
        /* Page Specific Overrides */
        body {
            padding-top: 80px;
        }

        .page-header {
            text-align: center;
            padding: 60px 20px 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        .page-header h1 {
            font-size: 56px;
            line-height: 1.07143;
            font-weight: 600;
            letter-spacing: -0.005em;
            margin-bottom: 6px;
            background: var(--hero-gradient-text);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-header p {
            font-size: 28px;
            line-height: 1.14286;
            font-weight: 400;
            letter-spacing: .007em;
            color: var(--text-secondary);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px 50px;
            max-width: 1400px;
            margin: 0 auto;
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 20px;
            }
        }

        .panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: saturate(180%) blur(30px);
            -webkit-backdrop-filter: saturate(180%) blur(30px);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.1), 0 0 20px -5px var(--glow-color);
        }

        [data-theme="light"] .panel {
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.65);
        }

        .panel h2 {
            font-size: 1.3rem;
            margin-bottom: 25px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        [data-theme="light"] .form-group input,
        [data-theme="light"] .form-group select,
        [data-theme="light"] .form-group textarea {
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(41, 151, 255, 0.5);
            box-shadow: 0 0 0 4px rgba(41, 151, 255, 0.15);
            background: rgba(255, 255, 255, 0.03);
            transform: translateY(-1px);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .api-input-wrapper {
            position: relative;
        }

        .api-input-wrapper input {
            padding-right: 50px;
        }

        .toggle-visibility {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }

        .toggle-visibility:hover {
            color: var(--text-primary);
        }

        .main-container .btn {
            width: 100%;
            padding: 14px;
            background: var(--text-primary);
            border: none;
            border-radius: 980px;
            color: var(--bg-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .main-container .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .main-container .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-container .btn-secondary {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Result Panel */
        .result-panel {
            display: flex;
            flex-direction: column;
        }

        .result-area {
            flex: 1;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 16px;
            border: 2px dashed rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .result-area.has-image {
            border-style: solid;
            align-items: flex-start;
        }

        /* Adaptive Single Image Frame */
        .result-area.has-image.is-single {
            width: auto;
            /* Shrink to content */
            max-width: 100%;
            /* Prevent overflow */
            align-self: center;
            /* Center in panel */
            flex: initial;
            /* Dont stretch vertically */
            min-height: auto;
            height: auto;
            border-radius: 12px;
            /* Tighter corners */
            padding: 8px;
            /* Frame thickness */
        }

        .result-area.has-image.is-single .result-image-container {
            padding: 0;
            /* Remove inner padding, use outer */
        }

        .result-area.has-image.is-grid {
            width: 100%;
            /* Full width for grid */
        }

        .result-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .result-placeholder span {
            font-size: 4rem;
            display: block;
            margin-bottom: 15px;
        }

        .result-image-container {
            width: 100%;
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        .result-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        /* Grid for multiple images */
        .result-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            width: 100%;
            gap: 15px;
            padding: 15px;
            align-items: start;
            align-content: start;
        }

        .result-image-grid .result-image {
            width: 100%;
            height: auto;
            max-height: none;
            aspect-ratio: 1;
            object-fit: cover;
            cursor: pointer;
        }

        .result-image-grid .result-image:hover {
            transform: scale(1.03);
            z-index: 10;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            z-index: 200;
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .result-actions .btn {
            flex: 1;
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        /* History */
        .history-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-section h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        /* .history-grid - Layout handled by Masonry */

        .history-item {
            position: relative;
            /* aspect-ratio: 1;  Removed for Masonry flow */
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .history-item:hover {
            border-color: var(--accent-blue);
            transform: scale(1.02);
        }

        .history-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .history-item .overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, transparent 60%);
            opacity: 0;
            pointer-events: none;
            /* Don't block clicks when hidden */
            transition: opacity 0.2s;
            display: flex;
            flex-direction: row;
            /* Change to row to stack horizontally if possible */
            flex-wrap: wrap;
            /* Allow wrapping */
            align-content: flex-end;
            /* Stick to bottom */
            padding: 6px;
            /* Reduce padding */
            gap: 4px;
        }

        .history-item:hover .overlay {
            opacity: 1;
            pointer-events: auto;
            /* Enable clicks when visible */
        }

        .history-item .overlay-btn {
            flex: 1;
            /* Grow to fill space */
            min-width: 45%;
            /* Ensure 2 per row roughly */
            padding: 4px 2px;
            /* Minimal padding */
            background: var(--accent-blue);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 10px;
            /* Smaller font */
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
        }

        .history-item .overlay-btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
        }

        /* Masonry Layout */
        .masonry-grid {
            column-count: 4;
            column-gap: 15px;
            padding: 15px 0;
        }

        .masonry-item {
            break-inside: avoid;
            margin-bottom: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Select Styles */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
        }

        .custom-select-wrapper select {
            display: none;
            /* Hide native */
        }

        .custom-select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(30, 30, 40, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .custom-select-trigger:hover {
            border-color: var(--accent-blue);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px var(--glow-color);
        }

        .custom-select-trigger::after {
            content: 'â–¼';
            font-size: 0.6em;
            color: var(--text-secondary);
            transition: transform 0.3s;
            margin-left: 10px;
        }

        .custom-select-wrapper.open .custom-select-trigger {
            border-color: var(--accent-blue);
            background: rgba(20, 20, 30, 1);
            border-radius: 12px 12px 0 0;
        }

        .custom-select-wrapper.open .custom-select-trigger::after {
            transform: rotate(180deg);
        }

        .custom-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20, 20, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: none;
            border-radius: 0 0 12px 12px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            max-height: 300px;
            overflow-y: auto;
        }

        .custom-select-wrapper.open .custom-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: center;
        }

        .custom-option:last-child {
            border-bottom: none;
        }

        .custom-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            padding-left: 20px;
        }

        .custom-option.selected {
            background: rgba(41, 151, 255, 0.2);
            color: #fff;
            border-left: 3px solid var(--accent-blue);
        }

        /* Light Mode Support for Custom Select */
        /* Light Mode Support for Custom Select */
        [data-theme="light"] .custom-select-trigger {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.15);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        [data-theme="light"] .custom-select-trigger:hover {
            background: rgba(255, 255, 255, 0.7);
            border-color: var(--accent-blue);
            box-shadow: 0 6px 20px rgba(0, 113, 227, 0.1);
        }

        [data-theme="light"] .custom-select-wrapper.open .custom-select-trigger {
            background: rgba(255, 255, 255, 0.85);
            border-color: var(--accent-blue);
        }

        [data-theme="light"] .custom-options {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }

        [data-theme="light"] .custom-option {
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
        }

        [data-theme="light"] .custom-option:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        [data-theme="light"] .custom-option.selected {
            background: rgba(0, 113, 227, 0.1);
            color: var(--accent-blue);
            border-left-color: var(--accent-blue);
        }

        /* Ripple Effect */
        .btn {
            position: relative;
            overflow: hidden;
        }

        span.ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        [data-theme="light"] .masonry-item {
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .masonry-item:hover {
            transform: translateY(-5px);
            z-index: 2;
            border-color: rgba(41, 151, 255, 0.6);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5), 0 0 20px rgba(41, 151, 255, 0.4);
        }

        /* Enhanced Toast Notification */
        .status-message {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(13, 13, 18, 0.9);
            color: #fff;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .status-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: all;
        }

        .status-message.success {
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        .status-message.error {
            border-color: rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        .status-message.info {
            border-color: rgba(41, 151, 255, 0.3);
            color: #2997ff;
        }

        [data-theme="light"] .status-message {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .masonry-item img {
            display: block;
            width: 100%;
            height: auto;
        }

        @media (max-width: 1200px) {
            .masonry-grid {
                column-count: 3;
            }
        }

        @media (max-width: 900px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        /* Mobile single column handled by media query or allow 2 cols for small images */
        @media (max-width: 600px) {
            .masonry-grid {
                column-count: 2;
                column-gap: 10px;
            }
        }

        /* Lightbox - Unified Design Language */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(13, 13, 18, 0.85);
            backdrop-filter: saturate(180%) blur(30px);
            -webkit-backdrop-filter: saturate(180%) blur(30px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        [data-theme="light"] .lightbox-overlay {
            background: rgba(251, 251, 253, 0.85);
        }

        /* Light mode Inpainting Modal specific styles */
        [data-theme="light"] #inpaintingModal {
            background: rgba(255, 255, 255, 0.5) !important;
        }

        [data-theme="light"] #inpaintingModal .panel {
            background: rgba(255, 255, 255, 0.6) !important;
            border-color: rgba(0, 0, 0, 0.08) !important;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.15) !important;
        }

        /* Floating action buttons - transparent in both modes */
        [data-theme="light"] #inpaintingModal .panel>div:first-child {
            background: transparent !important;
            border: none !important;
        }

        [data-theme="light"] #inpaintToolbar {
            background: rgba(255, 255, 255, 0.8) !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 0 20px rgba(0, 113, 227, 0.1) !important;
        }

        .lightbox-overlay.show {
            display: flex;
            opacity: 1;
        }

        .lightbox-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .lightbox-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .lightbox-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.4), 0 0 30px -10px var(--glow-color);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .lightbox-img:hover {
            transform: scale(1.01);
        }

        .lightbox-sidebar {
            width: 340px;
            background: var(--card-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            transform: translateX(0);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), width 0.3s, padding 0.3s;
        }

        [data-theme="light"] .lightbox-sidebar {
            border-left: 1px solid rgba(0, 0, 0, 0.08);
        }

        .lightbox-sidebar.hidden {
            transform: translateX(100%);
            width: 0;
            padding: 0;
        }

        .lightbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--nav-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        [data-theme="light"] .lightbox-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .lightbox-close {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        [data-theme="light"] .lightbox-close {
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .lightbox-close:hover {
            background: var(--card-hover);
            transform: scale(1.1);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--card-bg);
            backdrop-filter: saturate(180%) blur(10px);
            -webkit-backdrop-filter: saturate(180%) blur(10px);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        [data-theme="light"] .lightbox-nav {
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .lightbox-nav:hover {
            background: var(--card-hover);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .lightbox-prev {
            left: 24px;
        }

        .lightbox-next {
            right: 364px;
        }

        /* Adjust based on sidebar */
        .lightbox-sidebar.hidden+.lightbox-next {
            right: 24px;
        }

        .param-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 10px;
        }

        [data-theme="light"] .param-row {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .param-val {
            color: var(--text-primary);
            text-align: right;
        }

        /* Mobile Floating Panel */
        .mobile-fab {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--text-primary);
            color: var(--bg-color);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }

        @media (max-width: 900px) {
            .mobile-fab {
                display: flex;
            }

            .panel:first-child {
                /* Input Panel */
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                border-radius: 20px 20px 0 0;
                z-index: 999;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
                margin: 0;
            }

            .panel:first-child.show {
                transform: translateY(0);
            }

            .main-container {
                padding-bottom: 80px;
                grid-template-columns: 1fr;
            }
        }

        /* Optimize Button */
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .optimize-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s;
        }

        .optimize-btn:hover {
            transform: scale(1.05);
        }

        .optimize-btn.loading {
            opacity: 0.7;
            cursor: wait;
        }

        .clear-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 4px 10px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255, 71, 87, 0.1);
            border-color: rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        [data-theme="light"] .clear-btn {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }


        .history-item .parent-indicator {
            position: absolute;
            top: 6px;
            left: 6px;
            background: var(--accent-blue);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .history-item.is-reference {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .workflow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 20px;
        }

        /* Tree View Styles */
        .history-tree-view {
            padding: 20px 0;
            overflow-x: auto;
            min-height: 200px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .tree-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            padding: 10px 15px;
        }

        .node-content {
            position: relative;
            z-index: 2;
            min-width: 100px;
            max-width: 180px;
        }

        .node-content .history-item {
            width: auto;
            height: auto;
            max-width: 180px;
            margin: 0 auto;
        }

        .node-content .history-item img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .node-children {
            display: flex;
            justify-content: center;
            position: relative;
            padding-top: 30px;
            gap: 10px;
        }

        /* çˆ¶èŠ‚ç‚¹å‘ä¸‹çš„å‚ç›´è¿æ¥çº¿ */
        .node-children::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background: rgba(138, 180, 248, 0.6);
        }

        /* å­èŠ‚ç‚¹å‘ä¸Šçš„å‚ç›´è¿æ¥çº¿ */
        .node-children>.tree-node::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background: rgba(138, 180, 248, 0.6);
        }

        /* å•ä¸ªå­èŠ‚ç‚¹æ—¶éšè—æ°´å¹³çº¿ */
        .node-children.single-child>.tree-node::before {
            height: 30px;
            top: -30px;
        }

        .node-children.single-child::before {
            display: none;
        }

        /* æ ¹èŠ‚ç‚¹ä¸éœ€è¦å‘ä¸Šçš„è¿æ¥çº¿ */
        .history-tree-view>.tree-node::before {
            display: none;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }

        .view-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .view-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
        }


        /* Tutorial Guide Styles */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10010;
            pointer-events: none;
            display: none;
        }

        .tutorial-overlay.active {
            display: block;
        }

        .tutorial-spotlight {
            position: fixed;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75);
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10011;
            opacity: 0;
        }

        /* Pulse animation for spotlight */
        .tutorial-spotlight::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid var(--accent-blue);
            border-radius: 14px;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(41, 151, 255, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(41, 151, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(41, 151, 255, 0);
            }
        }

        .tutorial-tooltip {
            position: fixed;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 16px;
            width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            z-index: 10012;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: auto;
        }

        .tutorial-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .tutorial-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .tutorial-step-badge {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 100px;
        }

        .tutorial-content {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-skip {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
        }

        .tutorial-skip:hover {
            color: var(--text-primary);
        }

        .tutorial-next {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 980px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(41, 151, 255, 0.3);
        }

        .tutorial-next:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(41, 151, 255, 0.4);
        }

        [data-theme="light"] .tutorial-tooltip {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        [data-theme="light"] .tutorial-step-badge {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-secondary);
        }

        /* Style Presets */
        .style-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .style-tag {
            padding: 8px 14px;
            background: var(--bg-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 980px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .style-tag:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .style-tag.active {
            background: var(--text-primary);
            border-color: transparent;
            color: var(--bg-color);
            font-weight: 500;
        }

        /* Image Upload */
        .image-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(128, 128, 128, 0.05);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-upload-area:hover {
            border-color: var(--text-primary);
        }

        .image-upload-area.dragover {
            border-color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-placeholder {
            color: var(--text-secondary);
        }

        .upload-placeholder span {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 10px;
        }

        .upload-placeholder p {
            font-size: 0.9rem;
        }

        .upload-preview {
            position: relative;
            max-width: 100%;
        }

        .upload-preview img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            object-fit: contain;
        }

        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff4444;
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .remove-image:hover {
            transform: scale(1.1);
        }

        /* Advanced Settings */
        .advanced-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 15px;
            user-select: none;
        }

        .advanced-toggle:hover {
            color: var(--text-primary);
        }

        .advanced-settings {
            display: none;
            padding: 15px;
            background: rgba(128, 128, 128, 0.05);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .advanced-settings.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }



        .btn-save-key {
            padding: 5px 12px;
            background: var(--text-primary);
            border: none;
            border-radius: 15px;
            color: var(--bg-color);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-save-key:hover {
            opacity: 0.9;
        }

        .btn-save-key:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .history-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>

<body>

    <!-- Unified Navbar -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html" style="font-weight: 600; font-size: 16px;">AI Hub</a>
            <div class="nav-links">
                <a href="index.html">é¦–é¡µ</a>
                <a href="chat.html">å¯¹è¯</a>
                <a href="image.html">ç»˜å›¾</a>
                <a href="music.html">éŸ³ä¹</a>
                <a href="video.html">è§†é¢‘</a>
                <a href="forum.html">ç¤¾åŒº</a>
            </div>
            <div class="nav-actions" style="display: flex; align-items: center; gap: 15px;">
                <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜"
                    style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; padding: 0;"></button>
                <a href="login.html" id="loginBtn" class="btn btn-primary"
                    style="padding: 6px 16px; font-size: 12px; text-decoration: none;">ç™»å½•</a>
                <div id="userArea"
                    style="display: none; font-size: 12px; align-items: center; gap: 10px; color: var(--text-primary);">
                    <span id="userName">User</span>
                </div>
            </div>
        </div>
    </nav>

    <section class="page-header">
        <h1>AI ç»˜å›¾å·¥ä½œå®¤</h1>
        <p>æ”¯æŒ Gemini å¤šæ¨¡æ€å›¾ç”Ÿå›¾ (Nano Banana)ã€Replicate SDXL å’Œæœ¬åœ° SD WebUI</p>
    </section>

    <!-- Tutorial Elements -->
    <div class="tutorial-overlay" id="tutorialOverlay"></div>
    <div class="tutorial-spotlight" id="tutorialSpotlight"></div>
    <div class="tutorial-tooltip" id="tutorialTooltip">
        <div class="tutorial-header">
            <div class="tutorial-title" id="tutorialTitle">Title</div>
            <div class="tutorial-step-badge" id="tutorialBadge">1/5</div>
        </div>
        <div class="tutorial-content" id="tutorialContent">Content</div>
        <div class="tutorial-actions">
            <button class="tutorial-skip" onclick="skipTutorial()">è·³è¿‡æ•™ç¨‹</button>
            <button class="tutorial-next" onclick="nextTutorialStep()" id="tutorialNextBtn">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Input Panel -->
        <div class="panel">
            <h2>å‚æ•°è®¾ç½®</h2>

            <div class="form-group">
                <label>API æä¾›å•†</label>
                <select id="apiProvider" onchange="switchProvider()">
                    <option value="gemini">Gemini 2.5 Flash Image (æ¨èï¼Œæ”¯æŒå›¾ç”Ÿå›¾)</option>
                    <option value="replicate">Replicate SDXL</option>
                    <option value="custom">è‡ªå®šä¹‰ç«¯ç‚¹ (æœ¬åœ° SD WebUI)</option>
                </select>
                <small id="providerNote"
                    style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 8px; display: none;">
                    Gemini ä½¿ç”¨å¤šæ¨¡æ€ API (Nano Banana) å®ç°å›¾ç”Ÿå›¾ï¼Œæ”¯æŒæŒ‡ä»¤å¼ç¼–è¾‘
                </small>
            </div>

            <div class="form-group">
                <label>API Key <span id="apiKeyRequired">*</span></label>
                <div class="api-input-wrapper">
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ Replicate API Key" autocomplete="off">
                    <button class="toggle-visibility" onclick="toggleApiKeyVisibility()" title="æ˜¾ç¤º/éšè—">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap;">
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">
                        <span id="apiKeyHint">è·å– Key: <a href="https://replicate.com/account/api-tokens" target="_blank"
                                style="color: var(--text-primary);">replicate.com/account/api-tokens</a></span>
                    </small>
                    <button type="button" id="saveApiKeyBtn" class="btn-save-key" style="display: none;"
                        onclick="saveApiKeyToServer()">ä¿å­˜åˆ°è´¦æˆ·</button>
                </div>
                <div id="apiKeyStatus" style="color: #00ff88; font-size: 0.85rem; margin-top: 5px; display: none;">
                    å·²ä½¿ç”¨è´¦æˆ·ä¸­ä¿å­˜çš„ API Key
                </div>
            </div>

            <div class="form-group" id="modelGroup" style="display: none;">
                <label>æ¨¡å‹é€‰æ‹©</label>
                <select id="modelKey">
                    <option value="stability-ai/sdxl:39ed52f2a78e934b3ba6e2a89f5b1c712de7dfea535525255b1aa35c5565e08b">
                        Stable Diffusion XL (æ¨è)</option>
                    <option
                        value="stability-ai/stable-diffusion:ac732df83cea7fff18b8472768c88ad041fa750ff7682a21affe81863cbe77e4">
                        Stable Diffusion 1.5</option>
                    <option
                        value="lucataco/sdxl-lightning-4step:727e49a643e999d602a896c774a0658ffefea21465756a6ce24b7ea4165eba6a">
                        SDXL Lightning (å¿«é€Ÿ)</option>
                </select>
            </div>

            <div class="form-group" id="aspectRatioGroup">
                <label>å®½é«˜æ¯” (Aspect Ratio)</label>
                <select id="aspectRatio" onchange="updateResolutionHint()">
                    <option value="1:1" data-res="1024Ã—1024">1:1 æ­£æ–¹å½¢</option>
                    <option value="16:9" data-res="1344Ã—768">16:9 æ¨ªå±è§†é¢‘</option>
                    <option value="9:16" data-res="768Ã—1344">9:16 ç«–å±/æ‰‹æœºå£çº¸</option>
                    <option value="4:3" data-res="1184Ã—880">4:3 æ ‡å‡†ç…§ç‰‡</option>
                    <option value="3:4" data-res="880Ã—1184">3:4 ç«–å¹…ç…§ç‰‡</option>
                    <option value="3:2" data-res="1248Ã—832">3:2 å•åç…§ç‰‡</option>
                    <option value="2:3" data-res="832Ã—1248">2:3 ç«–å¹…å•å</option>
                    <option value="5:4" data-res="1136Ã—912">5:4 ä¸­ç”»å¹…</option>
                    <option value="4:5" data-res="912Ã—1136">4:5 Instagram</option>
                    <option value="21:9" data-res="1536Ã—656">21:9 ç”µå½±å®½ç”»å¹…</option>
                </select>
                <small id="resolutionHint"
                    style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px; display: block;">
                    ğŸ“ è¾“å‡ºåˆ†è¾¨ç‡: 1024Ã—1024
                </small>
            </div>

            <div class="form-group" id="imageCountGroup" style="display: none;">
                <label>ç”Ÿæˆæ•°é‡ (Number of Images)</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="range" id="imageCount" min="1" max="4" value="1" step="1"
                        oninput="document.getElementById('imageCountVal').textContent = this.value" style="flex:1;">
                    <span id="imageCountVal" style="width: 20px; text-align: center;">1</span>
                </div>
            </div>

            <div class="form-group" id="endpointGroup" style="display: none;">
                <label>API ç«¯ç‚¹ *</label>
                <input type="text" id="endpoint" placeholder="ä¾‹å¦‚: http://127.0.0.1:7860/sdapi/v1/txt2img">
                <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px; display: block;">
                    é€‚ç”¨äºæœ¬åœ° Stable Diffusion WebUI æˆ–å…¶ä»–å…¼å®¹ API
                </small>
            </div>

            <div class="form-group" id="referenceImageGroup">
                <label>å‚è€ƒå›¾ç‰‡ (å¯ä¼ å¤šå¼ ) *</label>
                <div class="image-upload-area" id="imageUploadArea"
                    onclick="document.getElementById('referenceImage').click()">
                    <input type="file" id="referenceImage" accept="image/*" multiple style="display: none;"
                        onchange="handleImageUpload(event)">

                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5" style="margin-bottom: 10px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å‚è€ƒå›¾ç‰‡</p>
                    </div>

                    <!-- Container for previews (Flex row for multi-shot) -->
                    <div id="previewContainer"
                        style="display: none; width: 100%; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <!-- Injected via JS using .upload-preview class -->
                    </div>
                </div>
            </div>

            <!-- Style Presets -->
            <div class="form-group">
                <label>é£æ ¼é¢„è®¾ <span style="color: var(--text-secondary); font-weight: normal;">(ç‚¹å‡»æ·»åŠ åˆ°æç¤ºè¯)</span></label>
                <div class="style-presets" id="stylePresets">
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="anime style, manga, cel shading">åŠ¨æ¼«</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="photorealistic, hyperrealistic, 8k uhd, dslr">å†™å®</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="oil painting, classical art, renaissance style">æ²¹ç”»</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="watercolor painting, soft colors, artistic">æ°´å½©</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="cyberpunk, neon lights, futuristic, sci-fi">èµ›åšæœ‹å…‹</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="fantasy art, magical, ethereal, mystical">å¥‡å¹»</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="pixel art, 16-bit, retro game style">åƒç´ é£</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="3d render, blender, octane render, c4d">3Dæ¸²æŸ“</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="minimalist, simple, clean design">æç®€</button>
                    <button type="button" class="style-tag" onclick="toggleStylePreset(this)"
                        data-style="studio ghibli style, hayao miyazaki">å‰åœåŠ›</button>
                </div>
            </div>

            <!-- Template Presets -->
            <div class="form-group">
                <label>å¿«æ·æ¨¡æ¿</label>
                <select id="promptTemplate" onchange="applyTemplate()">
                    <option value="">é€‰æ‹©æ¨¡æ¿å¿«é€Ÿå¡«å……...</option>
                    <option value="portrait">äººç‰©è‚–åƒ</option>
                    <option value="landscape">é£æ™¯å£®è§‚</option>
                    <option value="character">è§’è‰²è®¾è®¡</option>
                    <option value="product">äº§å“å±•ç¤º</option>
                    <option value="interior">å®¤å†…è®¾è®¡</option>
                    <option value="logo">Logoè®¾è®¡</option>
                </select>
            </div>

            <div class="form-group">
                <div class="prompt-header">
                    <label style="margin-bottom: 0;">æç¤ºè¯ (Prompt) *</label>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="optimize-btn" onclick="optimizePrompt()" id="optimizeBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83">
                                </path>
                            </svg>
                            <span>æ™ºèƒ½ä¼˜åŒ–</span>
                        </button>
                        <button type="button" class="clear-btn" onclick="copyPrompt()" title="å¤åˆ¶æç¤ºè¯">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>å¤åˆ¶</span>
                        </button>
                        <button type="button" class="clear-btn" onclick="clearPrompt()" title="æ¸…ç©ºæç¤ºè¯">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                            </svg>
                            <span>æ¸…ç©º</span>
                        </button>
                    </div>
                </div>
                <textarea id="prompt"
                    placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡å†…å®¹...&#10;ä¾‹å¦‚: A beautiful sunset over mountains, digital art, highly detailed, 4k&#10;&#10;ç‚¹å‡»ä¸Šæ–¹é£æ ¼æ ‡ç­¾å¯å¿«é€Ÿæ·»åŠ é£æ ¼è¯"></textarea>
            </div>

            <div class="form-group">
                <div class="prompt-header">
                    <label style="margin-bottom: 0;">åå‘æç¤ºè¯ (Negative Prompt)</label>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="clear-btn" onclick="copyNegativePrompt()" title="å¤åˆ¶åå‘æç¤ºè¯">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span>å¤åˆ¶</span>
                        </button>
                        <button type="button" class="clear-btn" onclick="clearNegativePrompt()" title="æ¸…ç©ºåå‘æç¤ºè¯">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                            </svg>
                            <span>æ¸…ç©º</span>
                        </button>
                    </div>
                </div>
                <textarea id="negativePrompt" placeholder="æè¿°ä½ ä¸æƒ³å‡ºç°çš„å†…å®¹...&#10;ä¾‹å¦‚: blurry, low quality, distorted"
                    style="min-height: 80px;"></textarea>
            </div>

            <div class="advanced-toggle" onclick="toggleAdvanced()">
                <span id="advancedIcon">â–¶</span> é«˜çº§è®¾ç½®
            </div>

            <div class="advanced-settings" id="advancedSettings">
                <div class="form-row">
                    <div class="form-group" id="widthGroup">
                        <label>å®½åº¦ (Width)</label>
                        <select id="width">
                            <option value="512" selected>512px</option>
                            <option value="640">640px</option>
                            <option value="768">768px</option>
                            <option value="896">896px</option>
                            <option value="1024">1024px</option>
                            <option value="1152">1152px</option>
                            <option value="1280">1280px</option>
                            <option value="1536">1536px</option>
                        </select>
                    </div>
                    <div class="form-group" id="heightGroup">
                        <label>é«˜åº¦ (Height)</label>
                        <select id="height">
                            <option value="512" selected>512px</option>
                            <option value="640">640px</option>
                            <option value="768">768px</option>
                            <option value="896">896px</option>
                            <option value="1024">1024px</option>
                            <option value="1152">1152px</option>
                            <option value="1280">1280px</option>
                            <option value="1536">1536px</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" id="stepsGroup">
                        <label>é‡‡æ ·æ­¥æ•° (Steps)</label>
                        <input type="number" id="steps" value="30" min="1" max="150">
                    </div>
                    <div class="form-group" id="cfgGroup">
                        <label>å¼•å¯¼ç³»æ•° (CFG Scale)</label>
                        <input type="number" id="cfgScale" value="7.5" min="1" max="20" step="0.5">
                    </div>
                </div>

                <div class="form-group" id="temperatureGroup" style="display: none;">
                    <label>åˆ›æ„åº¦ (Temperature): <span id="tempVal">0.9</span></label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.9"
                        oninput="document.getElementById('tempVal').textContent = this.value">
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">å€¼è¶Šé«˜è¶Šæœ‰åˆ›æ„ï¼Œä½†ä¹Ÿå¯èƒ½è¶Šä¸å¯æ§</small>
                </div>

                <div class="form-group" id="safetyGroup" style="display: none;">
                    <label>å®‰å…¨è¿‡æ»¤ç­‰çº§ (Safety Filter)</label>
                    <select id="safetySettings">
                        <option value="BLOCK_ONLY_HIGH">ä»…æ‹¦æˆªé«˜é£é™© (é»˜è®¤)</option>
                        <option value="BLOCK_MEDIUM_AND_ABOVE">æ‹¦æˆªä¸­ç­‰åŠä»¥ä¸Š</option>
                        <option value="BLOCK_LOW_AND_ABOVE">æ‹¦æˆªä½é£é™©åŠä»¥ä¸Š</option>
                        <option value="BLOCK_NONE">ä¸è¿‡æ»¤ (æ…ç”¨)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>éšæœºç§å­ (Seedï¼Œ-1ä¸ºéšæœº)</label>
                    <input type="number" id="seed" value="-1">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn" onclick="generateImage()" id="generateBtn">
                    ç”Ÿæˆå›¾ç‰‡
                </button>
            </div>

        </div>

        <!-- Result Panel -->
        <div class="panel result-panel">
            <h2>ç”Ÿæˆç»“æœ</h2>

            <div class="result-area" id="resultArea">
                <div class="result-placeholder" id="placeholder">
                    <span></span>
                    <p>è¾“å…¥æç¤ºè¯å¹¶ç‚¹å‡»ç”Ÿæˆ</p>
                </div>
                <div id="resultContainer" class="result-image-container" style="display: none;">
                    <!-- Images will be injected here -->
                    <img class="result-image" id="resultImage" style="display: none;">
                </div>
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="spinner"></div>
                    <div class="loading-text">æ­£åœ¨ç”Ÿæˆä¸­...</div>
                </div>
            </div>

            <div class="result-actions" id="resultActions" style="display: none;">
                <button class="btn btn-secondary" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
                <button class="btn btn-secondary" onclick="copyPrompt()">å¤åˆ¶æç¤ºè¯</button>
            </div>

            <div class="history-section" id="historySection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>å†å²è®°å½•</h3>
                    <div class="view-toggle">
                        <button class="view-btn active" onclick="switchHistoryView('grid')" id="viewBtnGrid">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            ç½‘æ ¼
                        </button>
                        <button class="view-btn" onclick="switchHistoryView('tree')" id="viewBtnTree">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="5" r="3" />
                                <path d="M12 8v5" />
                                <path d="M5 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                                <path d="M19 19a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                                <path d="M12 13l-7 3" />
                                <path d="M12 13l7 3" />
                            </svg>
                            æ ‘çŠ¶å›¾
                        </button>
                    </div>
                </div>
                <div class="history-grid" id="historyGrid"></div>
                <div class="history-tree-view" id="historyTreeView" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Mobile FAB -->
    <button class="mobile-fab" onclick="toggleMobilePanel()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
            </path>
        </svg>
    </button>

    <!-- Lightbox -->
    <div class="lightbox-overlay" id="lightbox">
        <div class="lightbox-header">
            <span style="font-weight: 600;">å›¾ç‰‡é¢„è§ˆ</span>
            <div style="display:flex; gap:15px; align-items:center;">
                <button class="btn-save-key" onclick="toggleLightboxSidebar()">è¯¦æƒ…</button>
                <button class="lightbox-close" onclick="closeLightbox()"><svg xmlns="http://www.w3.org/2000/svg"
                        width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
        </div>
        <div class="lightbox-content">
            <div class="lightbox-main">
                <button class="lightbox-nav lightbox-prev" onclick="lightboxNavigate(-1)"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg></button>
                <img src="" class="lightbox-img" id="lightboxImg">
                <button class="lightbox-nav lightbox-next" onclick="lightboxNavigate(1)"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg></button>
            </div>
            <div class="lightbox-sidebar" id="lightboxSidebar">
                <!-- Info injected here -->
            </div>
        </div>
    </div>

    <script src="scripts/layout.js"></script>
    <script>
        // User auth state
        const userToken = localStorage.getItem('ai-hub-token');
        let serverApiKeyStatus = { gemini: false, replicate: false };

        async function checkAuthAndLoadApiKeys() {
            if (!userToken) { document.getElementById('saveApiKeyBtn').style.display = 'none'; return; }
            try {
                const verifyRes = await fetch('/api/verify', { headers: { 'Authorization': `Bearer ${userToken}` } });
                if (!verifyRes.ok) { localStorage.removeItem('ai-hub-token'); return; }
                const keysRes = await fetch('/api/user/apikeys', { headers: { 'Authorization': `Bearer ${userToken}` } });
                if (keysRes.ok) { const data = await keysRes.json(); serverApiKeyStatus = data.configured || { gemini: false, replicate: false }; }
                document.getElementById('saveApiKeyBtn').style.display = 'inline-block';
                updateApiKeyUI();
                loadHistoryFromServer(); // Load history
            } catch (error) { console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error); }
        }

        async function loadHistoryFromServer() {
            try {
                const res = await fetch('/api/image/history?limit=60', { headers: { 'Authorization': `Bearer ${userToken}` } });
                const data = await res.json();
                if (res.ok && data.history) {
                    imageHistory = data.history.map(item => ({
                        id: item.id.toString(),
                        image: item.image_path,
                        prompt: item.prompt,
                        negativePrompt: item.negative_prompt,
                        params: item.params ? JSON.parse(item.params) : {},
                        isServer: true
                    }));
                    renderHistory();
                }
            } catch (e) { console.error('Load history failed', e); }
        }

        // Optimize Prompt
        // Prompt Actions
        let lastPrompt = '';
        let lastNegativePrompt = '';

        function clearPrompt() {
            const el = document.getElementById('prompt');
            if (!el.value) return;
            lastPrompt = el.value;
            el.value = '';
            el.focus();
            showStatus('æç¤ºè¯å·²æ¸…ç©º', 'info', {
                text: 'æ’¤é”€',
                callback: () => {
                    el.value = lastPrompt;
                    showStatus('å·²æ¢å¤æç¤ºè¯', 'success');
                }
            });
        }

        function clearNegativePrompt() {
            const el = document.getElementById('negativePrompt');
            if (!el.value) return;
            lastNegativePrompt = el.value;
            el.value = '';
            el.focus();
            showStatus('åå‘æç¤ºè¯å·²æ¸…ç©º', 'info', {
                text: 'æ’¤é”€',
                callback: () => {
                    el.value = lastNegativePrompt;
                    showStatus('å·²æ¢å¤åå‘æç¤ºè¯', 'success');
                }
            });
        }

        function copyPrompt() {
            const text = document.getElementById('prompt').value;
            if (!text) return showStatus('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'warning');
            navigator.clipboard.writeText(text).then(() => showStatus('æç¤ºè¯å·²å¤åˆ¶', 'success'));
        }

        function copyNegativePrompt() {
            const text = document.getElementById('negativePrompt').value;
            if (!text) return showStatus('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹', 'warning');
            navigator.clipboard.writeText(text).then(() => showStatus('åå‘æç¤ºè¯å·²å¤åˆ¶', 'success'));
        }

        async function optimizePrompt() {
            const promptInput = document.getElementById('prompt');
            const originalPrompt = promptInput.value.trim();
            if (!originalPrompt) { showStatus('è¯·å…ˆè¾“å…¥ä¸€äº›å…³é”®è¯', 'info'); return; }
            const btn = document.getElementById('optimizeBtn');
            const originalHtml = btn.innerHTML;

            btn.classList.add('loading');
            btn.innerHTML = '<span>æ€è€ƒä¸­...</span>';
            btn.disabled = true;

            try {
                const provider = document.getElementById('apiProvider').value;
                // Use user auth if available for key
                const headers = { 'Content-Type': 'application/json' };
                if (userToken) headers['Authorization'] = `Bearer ${userToken}`;

                // If user hasn't set custom key, and we need one?
                // The optimize endpoint handles key retrieval from user account

                const res = await fetch('/api/chat/optimize-prompt', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        prompt: originalPrompt,
                        apiKey: document.getElementById('apiKey').value // Optional pass-through
                    })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Optimization failed');

                // Typing effect
                simulateTyping(promptInput, data.optimizedPrompt);
                showStatus('æç¤ºè¯å·²ä¼˜åŒ–', 'success');
                setTimeout(hideStatus, 2000);
            } catch (error) {
                showStatus('ä¼˜åŒ–å¤±è´¥: ' + error.message, 'error');
            } finally {
                btn.classList.remove('loading');
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        function simulateTyping(element, text) {
            let i = 0;
            element.value = '';
            const interval = setInterval(() => {
                element.value += text.charAt(i);
                i++;
                if (i > text.length - 1) clearInterval(interval);
            }, 10);
        }

        function toggleMobilePanel() {
            const panel = document.querySelector('.panel');
            panel.classList.toggle('show');
        }

        /* Lightbox Functions */
        let currentLightboxIndex = 0;

        function openLightbox(index) {
            currentLightboxIndex = index;
            const overlay = document.getElementById('lightbox');
            overlay.classList.add('show');
            updateLightboxContent();
            document.body.style.overflow = 'hidden';

            document.addEventListener('keydown', handleLightboxKey);
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('show');
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleLightboxKey);
        }

        function handleLightboxKey(e) {
            if (e.key === 'Escape') closeLightbox();
            if (e.key === 'ArrowLeft') lightboxNavigate(-1);
            if (e.key === 'ArrowRight') lightboxNavigate(1);
        }

        function lightboxNavigate(dir) {
            const newIndex = currentLightboxIndex + dir;
            if (newIndex >= 0 && newIndex < imageHistory.length) {
                currentLightboxIndex = newIndex;
                updateLightboxContent();
            }
        }

        function updateLightboxContent() {
            const item = imageHistory[currentLightboxIndex];
            document.getElementById('lightboxImg').src = item.image;

            const sidebar = document.getElementById('lightboxSidebar');
            const params = item.params || {};

            sidebar.innerHTML = `
                <div style="margin-bottom:20px;">
                    <strong style="display:block; margin-bottom:10px; color:#fff;">æç¤ºè¯</strong>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; font-size:0.9rem; line-height:1.5;">${escapeHtml(item.prompt)}</div>
                </div>
                ${item.negativePrompt ? `
                <div style="margin-bottom:20px;">
                    <strong style="display:block; margin-bottom:10px; color:#fff;">åå‘æç¤ºè¯</strong>
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; font-size:0.9rem;">${escapeHtml(item.negativePrompt)}</div>
                </div>` : ''}
                
                <h4 style="color:var(--text-secondary); margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">å‚æ•°è¯¦æƒ…</h4>
                <div class="param-row"><span>æ¨¡å‹</span><span class="param-val">${params.model || 'Unknown'}</span></div>
                <div class="param-row"><span>å®½é«˜æ¯”</span><span class="param-val">${params.aspectRatio || 'Default'}</span></div>
                <div class="param-row"><span>Steps</span><span class="param-val">${params.steps || '-'}</span></div>
                <div class="param-row"><span>CFG Scale</span><span class="param-val">${params.cfg || '-'}</span></div>
                <div class="param-row"><span>Seed</span><span class="param-val">${params.seed || '-'}</span></div>

                <div style="margin-top:30px; display:grid; gap:10px;">
                    <button class="btn" onclick="useAsReference(${currentLightboxIndex}); closeLightbox()">ç”¨ä½œå‚è€ƒ</button>
                    <button class="btn btn-secondary" onclick="window.open('${item.image}', '_blank')">æŸ¥çœ‹åŸå›¾</button>
                    <button class="btn btn-secondary" onclick="downloadItem('${item.image}')">ä¸‹è½½</button>
                </div>
            `;
        }

        function toggleLightboxSidebar() {
            document.getElementById('lightboxSidebar').classList.toggle('hidden');
        }

        function remixImage(index) {
            const item = imageHistory[index];
            if (!item) return;

            // Fill prompts
            document.getElementById('prompt').value = item.prompt;
            if (item.negativePrompt) document.getElementById('negativePrompt').value = item.negativePrompt;

            // Fill params if available
            // Fill params if available
            if (item.params) {
                if (item.params.aspectRatio) { const el = document.getElementById('aspectRatio'); el.value = item.params.aspectRatio; el.dispatchEvent(new Event('change')); }
                if (item.params.steps) { const el = document.getElementById('steps'); el.value = item.params.steps; el.dispatchEvent(new Event('change')); }
                if (item.params.cfg) document.getElementById('cfgScale').value = item.params.cfg;
                if (item.params.seed) document.getElementById('seed').value = item.params.seed;
            }

            // Set as reference image (Simplified: convert back to base64 if possible or just use URL if CORS allows)

            // Set as reference image (Simplified: convert back to base64 if possible or just use URL if CORS allows)
            // For now, we skip setting reference image automatically because of cross-origin tainting issues with simple img.src
            // But we can try:
            useAsReference(index);

            showStatus('å·²åŠ è½½æç¤ºè¯å’Œå‚æ•° (Remix Mode)', 'success');
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Custom Components Initialization
        document.addEventListener('DOMContentLoaded', () => {
            initCustomSelects();
            initRippleEffect();
        });

        function initCustomSelects() {
            const selects = document.querySelectorAll('select:not(.no-custom)');
            selects.forEach(select => {
                if (select.parentNode.classList.contains('custom-select-wrapper')) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper';
                select.parentNode.insertBefore(wrapper, select);
                wrapper.appendChild(select);

                const trigger = document.createElement('div');
                trigger.className = 'custom-select-trigger';
                trigger.innerHTML = `<span>${select.options[select.selectedIndex]?.text || ''}</span>`;
                wrapper.appendChild(trigger);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-options';

                Array.from(select.options).forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'custom-option' + (option.selected ? ' selected' : '');
                    optionDiv.textContent = option.text;
                    optionDiv.dataset.value = option.value;
                    optionDiv.onclick = (e) => {
                        e.stopPropagation();
                        // Update UI
                        trigger.querySelector('span').textContent = option.text;
                        optionsDiv.querySelectorAll('.custom-option').forEach(el => el.classList.remove('selected'));
                        optionDiv.classList.add('selected');

                        // Update Select
                        select.value = option.value;
                        wrapper.classList.remove('open');

                        // Trigger Change Event
                        const event = new Event('change', { bubbles: true });
                        select.dispatchEvent(event);
                    };
                    optionsDiv.appendChild(optionDiv);
                });
                wrapper.appendChild(optionsDiv);

                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Close others
                    document.querySelectorAll('.custom-select-wrapper.open').forEach(el => {
                        if (el !== wrapper) el.classList.remove('open');
                    });
                    wrapper.classList.toggle('open');
                });
            });

            // Close on outside click
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-select-wrapper.open').forEach(el => el.classList.remove('open'));
            });

            // Listen for external value changes
            selects.forEach(select => {
                select.addEventListener('change', () => {
                    const wrapper = select.parentNode;
                    if (wrapper.classList.contains('custom-select-wrapper')) {
                        const trigger = wrapper.querySelector('.custom-select-trigger span');
                        const options = wrapper.querySelectorAll('.custom-option');
                        if (select.selectedIndex >= 0) {
                            trigger.textContent = select.options[select.selectedIndex].text;
                            options.forEach(opt => {
                                opt.classList.toggle('selected', opt.dataset.value === select.value);
                            });
                        }
                    }
                });
            });
        }

        function initRippleEffect() {
            const buttons = document.querySelectorAll('.btn, .overlay-btn, .custom-option');
            buttons.forEach(btn => {
                btn.addEventListener('click', createRipple);
            });
            // Delegation
            document.addEventListener('click', (e) => {
                const target = e.target.closest('.btn') || e.target.closest('.overlay-btn');
                if (target) {
                    createRipple({ currentTarget: target, clientX: e.clientX, clientY: e.clientY });
                }
            });
        }

        function createRipple(event) {
            const button = event.currentTarget;
            if (!button) return;

            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;
            const rect = button.getBoundingClientRect();

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - rect.left - radius}px`;
            circle.style.top = `${event.clientY - rect.top - radius}px`;
            circle.classList.add('ripple');

            const existingRipple = button.getElementsByClassName('ripple')[0];
            if (existingRipple) {
                existingRipple.remove();
            }

            button.appendChild(circle);
            setTimeout(() => circle.remove(), 600);
        }

        checkAuthAndLoadApiKeys();
        function downloadItem(url) {
            const link = document.createElement('a');
            link.download = `ai-draw-${Date.now()}.png`;
            link.href = url;
            link.click();
        }



        function updateApiKeyUI() {
            const provider = document.getElementById('apiProvider').value;
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            const apiKeyRequired = document.getElementById('apiKeyRequired');
            if (provider === 'custom') { apiKeyStatus.style.display = 'none'; apiKeyRequired.textContent = ''; return; }
            const hasServerKey = serverApiKeyStatus[provider];
            if (hasServerKey && !apiKeyInput.value.trim()) {
                apiKeyStatus.style.display = 'block'; apiKeyRequired.textContent = '(å¯é€‰)'; apiKeyInput.placeholder = 'ç•™ç©ºä½¿ç”¨è´¦æˆ·ä¸­ä¿å­˜çš„ Keyï¼Œæˆ–è¾“å…¥æ–° Key';
            } else {
                apiKeyStatus.style.display = 'none'; apiKeyRequired.textContent = hasServerKey ? '(å¯é€‰)' : '*';
            }
        }

        async function saveApiKeyToServer() {
            const provider = document.getElementById('apiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            if (provider === 'custom') { showStatus('è‡ªå®šä¹‰ç«¯ç‚¹ä¸æ”¯æŒä¿å­˜åˆ°è´¦æˆ·', 'error'); return; }
            if (!apiKey) { showStatus('è¯·å…ˆè¾“å…¥ API Key', 'error'); return; }
            if (!userToken) { showStatus('è¯·å…ˆç™»å½•åå†ä¿å­˜ API Key', 'error'); return; }
            const btn = document.getElementById('saveApiKeyBtn'); btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­...';
            try {
                const res = await fetch('/api/user/apikeys', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${userToken}` }, body: JSON.stringify({ provider, apiKey }) });
                const data = await res.json();
                if (res.ok) { serverApiKeyStatus[provider] = true; localStorage.removeItem('ai-draw-api-key'); showStatus('API Key å·²å®‰å…¨ä¿å­˜åˆ°è´¦æˆ·', 'success'); updateApiKeyUI(); setTimeout(hideStatus, 3000); }
                else { showStatus(data.error || 'ä¿å­˜å¤±è´¥', 'error'); }
            } catch (error) { showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error'); }
            finally { btn.disabled = false; btn.textContent = 'ğŸ”’ ä¿å­˜åˆ°è´¦æˆ·'; }
        }

        // Load saved settings
        const savedApiKey = localStorage.getItem('ai-draw-api-key');
        const savedProvider = localStorage.getItem('ai-draw-provider') || 'gemini';
        const savedEndpoint = localStorage.getItem('ai-draw-endpoint');
        if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
        document.getElementById('apiProvider').value = savedProvider;
        if (savedEndpoint) document.getElementById('endpoint').value = savedEndpoint;

        // Check Models Button removed - Gemini not supported for image generation

        switchProvider(); // Just ensure UI state
        checkAuthAndLoadApiKeys();

        let imageHistory = JSON.parse(localStorage.getItem('ai-draw-history') || '[]');
        let referenceImagesData = []; // Array of { base64, mimeType }
        let currentReferenceId = null;
        let currentViewMode = 'grid';
        renderHistory();

        function handleImageUpload(event) {
            const files = event.target.files;
            if (files && files.length > 0) processImageFiles(files);
            // Reset input so same files can be selected again if needed
            event.target.value = '';
        }

        async function processImageFiles(files) {
            // Limit to 5 images max
            if (referenceImagesData.length + files.length > 5) {
                showStatus('æœ€å¤šåªèƒ½ä¸Šä¼  5 å¼ å‚è€ƒå›¾', 'error');
                return;
            }

            const placeholder = document.getElementById('uploadPlaceholder');
            const previewGrid = document.getElementById('previewGrid');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.startsWith('image/')) { showStatus(`æ–‡ä»¶ ${file.name} ä¸æ˜¯å›¾ç‰‡`, 'error'); continue; }
                if (file.size > 10 * 1024 * 1024) { showStatus(`å›¾ç‰‡ ${file.name} è¶…è¿‡ 10MB`, 'error'); continue; }

                try {
                    const base64Data = await readFileAsBase64(file);
                    // Add to array
                    referenceImagesData.push({
                        base64: base64Data.split(',')[1],
                        mimeType: file.type,
                        preview: base64Data
                    });
                } catch (e) {
                    console.error(e);
                }
            }

            renderReferencePreviews();
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function renderReferencePreviews() {
            const placeholder = document.getElementById('uploadPlaceholder');
            const container = document.getElementById('previewContainer');

            if (referenceImagesData.length === 0) {
                placeholder.style.display = 'block';
                container.style.display = 'none';
                container.innerHTML = '';
            } else {
                placeholder.style.display = 'none';
                container.style.display = 'flex';
                // Use the original .upload-preview style but allow multiples
                container.innerHTML = referenceImagesData.map((img, index) => `
                    <div class="upload-preview" onclick="event.stopPropagation()">
                        <img src="${img.preview}" alt="é¢„è§ˆ">
                        ${img.hasMask ? '<div class="mask-badge" style="position:absolute; top:5px; left:5px; background:var(--accent-blue); color:white; padding:2px 6px; border-radius:4px; font-size:10px;">Masked</div>' : ''}
                        
                        <div style="position:absolute; bottom:5px; left:5px; display:flex; gap:5px;">
                             <button class="remove-image" onclick="openInpaintingEditor('${img.preview}'); currentEditingIndex = ${index};" title="å±€éƒ¨é‡ç»˜" style="position:static; transform:none; background:rgba(0,0,0,0.6);"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg></button>
                        </div>

                        <button class="remove-image" onclick="removeReferenceImage(event, ${index})"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                `).join('');
            }
        }

        let currentEditingIndex = -1;

        // Hook into save function to update specific item (deferred until all scripts loaded)
        window.addEventListener('load', function() {
            if (typeof saveInpaintingMask === 'function') {
                const originalSaveMask = saveInpaintingMask;
                window.saveInpaintingMask = function () {
                    const canvas = document.getElementById('inpaintingCanvas');
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = canvas.width; finalCanvas.height = canvas.height;
                    const finalCtx = finalCanvas.getContext('2d');
                    finalCtx.fillStyle = '#000000'; finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                    finalCtx.drawImage(canvas, 0, 0);

                    // Threshold
                    const imageData = finalCtx.getImageData(0, 0, finalCanvas.width, finalCanvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] > 20) { data[i] = 255; data[i + 1] = 255; data[i + 2] = 255; data[i + 3] = 255; }
                        else { data[i] = 0; data[i + 1] = 0; data[i + 2] = 0; data[i + 3] = 255; }
                    }
                    finalCtx.putImageData(imageData, 0, 0);

                    const maskBase64 = finalCanvas.toDataURL('image/png');

                    // Save to the specific reference item
                    if (currentEditingIndex >= 0 && referenceImagesData[currentEditingIndex]) {
                        referenceImagesData[currentEditingIndex].mask = maskBase64;
                        referenceImagesData[currentEditingIndex].hasMask = true;
                        renderReferencePreviews();
                        showStatus('é®ç½©å·²åº”ç”¨åˆ°å›¾ç‰‡', 'success');
                    }

                    closeInpaintingModal();
                };
            }
        });

        function removeReferenceImage(event, index) {
            event.stopPropagation();
            referenceImagesData.splice(index, 1);
            renderReferencePreviews();
        }

        // Drag and drop
        const uploadArea = document.getElementById('imageUploadArea');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => { uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files && files.length > 0) processImageFiles(files);
        });

        // Style presets - toggle function called by onclick
        function toggleStylePreset(btn) {
            const style = btn.dataset.style;
            const promptEl = document.getElementById('prompt');
            const isCurrentlyActive = btn.classList.contains('active');

            if (isCurrentlyActive) {
                // Remove the style from prompt using string replace
                btn.classList.remove('active');
                let current = promptEl.value;
                // Try to remove ", style" or "style, " or just "style"
                current = current.replace(', ' + style, '');
                current = current.replace(style + ', ', '');
                current = current.replace(style, '');
                promptEl.value = current.trim();
            } else {
                // Add the style to prompt
                btn.classList.add('active');
                const current = promptEl.value.trim();
                promptEl.value = current ? current + ', ' + style : style;
            }
        }

        // Templates
        const templates = {
            portrait: { prompt: "A portrait of a beautiful woman, soft lighting, detailed face, elegant, professional photography, 8k", negative: "ugly, deformed, blurry, bad anatomy, bad proportions" },
            landscape: { prompt: "Epic mountain landscape at golden hour, dramatic clouds, crystal clear lake reflection, nature photography, 8k ultra HD", negative: "people, buildings, text, watermark, blurry" },
            character: { prompt: "Character design sheet, fantasy warrior, multiple poses, detailed armor, concept art, artstation trending", negative: "blurry, low quality, amateur, bad anatomy" },
            product: { prompt: "Product photography, sleek modern design, studio lighting, white background, commercial quality, 8k", negative: "text, watermark, blurry, low quality" },
            interior: { prompt: "Modern interior design, minimalist living room, natural lighting, architectural digest style, 8k", negative: "people, clutter, blurry, distorted" },
            logo: { prompt: "Minimalist logo design, vector art, clean lines, professional branding, modern, scalable", negative: "complex, photorealistic, blurry, text" }
        };
        function applyTemplate() {
            const select = document.getElementById('promptTemplate'); const templateKey = select.value; if (!templateKey) return;
            const template = templates[templateKey];
            if (template) { document.getElementById('prompt').value = template.prompt; document.getElementById('negativePrompt').value = template.negative; document.querySelectorAll('.style-tag').forEach(tag => tag.classList.remove('active')); showStatus('å·²åº”ç”¨æ¨¡æ¿: ' + select.options[select.selectedIndex].text, 'success'); setTimeout(hideStatus, 2000); }
            select.value = '';
            select.dispatchEvent(new Event('change'));
        }

        function updateResolutionHint() {
            const select = document.getElementById('aspectRatio');
            const hint = document.getElementById('resolutionHint');
            if (!select || !hint) return;

            const selectedOption = select.options[select.selectedIndex];
            const res = selectedOption.getAttribute('data-res') || '1024Ã—1024';
            hint.textContent = 'ğŸ“ è¾“å‡ºåˆ†è¾¨ç‡: ' + res;
        }

        // Tutorial Logic
        var tutorialSteps = [
            {
                element: null, // Global welcome
                title: "æ¬¢è¿ä½¿ç”¨ Banana Draw",
                content: "åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥é€šè¿‡ AI é‡Šæ”¾æ— é™åˆ›æ„ã€‚è®©æˆ‘ä»¬èŠ± 1 åˆ†é’Ÿäº†è§£å¦‚ä½•ç”Ÿæˆç‹¬ç‰¹çš„å›¾åƒã€‚",
                position: "center"
            },
            {
                element: "#stylePresets",
                title: "1. é£æ ¼é¢„è®¾",
                content: "ä¸çŸ¥é“æ€ä¹ˆå†™æç¤ºè¯ï¼Ÿç‚¹å‡»è¿™äº›é£æ ¼æ ‡ç­¾ï¼Œå¿«é€Ÿä¸ºæ‚¨çš„åˆ›ä½œå®šä¸‹åŸºè°ƒã€‚å†æ¬¡ç‚¹å‡»å³å¯ç§»é™¤åŠå–æ¶ˆã€‚",
                position: "bottom"
            },
            {
                element: "#prompt",
                title: "2. æè¿°æ‚¨çš„åˆ›æ„",
                content: "åœ¨è¿™é‡Œè¾“å…¥æ‚¨æƒ³è¦ç”Ÿæˆçš„ç”»é¢æè¿°ã€‚æ”¯æŒä¸­æ–‡ï¼Œè¶Šè¯¦ç»†æ•ˆæœè¶Šå¥½ï¼",
                position: "bottom"
            },
            {
                element: "#optimizeBtn",
                title: "3. æ™ºèƒ½ä¼˜åŒ– (ç¥å™¨)",
                content: "å¼ºçƒˆæ¨èï¼ç‚¹å‡»è¿™ä¸ªé­”æ³•æ£’ï¼ŒAI ä¼šè‡ªåŠ¨å¸®æ‚¨æ‰©å†™å’Œæ¶¦è‰²æç¤ºè¯ï¼Œè®©ç”»é¢ç»†èŠ‚æ›´ä¸°å¯Œã€‚",
                position: "bottom"
            },
            {
                element: "#imageUploadArea",
                title: "4. å‚è€ƒå›¾ (å¯é€‰)",
                content: "æƒ³è¦ç”Ÿæˆç‰¹å®šæ„å›¾æˆ–é£æ ¼ï¼Ÿä¸Šä¼ ä¸€å¼ å‚è€ƒå›¾ï¼ŒAI ä¼šå‚è€ƒå®ƒçš„ç‰¹å¾æ¥åˆ›ä½œã€‚",
                position: "right"
            },
            {
                element: "#generateBtn",
                title: "5. å¼€å§‹ç”Ÿæˆ",
                content: "ä¸€åˆ‡å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»ç”Ÿæˆï¼ç¨ç­‰ç‰‡åˆ»ï¼Œå¥‡è¿¹å°±ä¼šå‘ç”Ÿã€‚",
                position: "top"
            },
            {
                element: "#resultArea",
                title: "6. ç»“æœåŒºåŸŸ",
                content: "ç”Ÿæˆçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚æ‚¨å¯ä»¥é¢„è§ˆã€ä¸‹è½½ï¼Œæˆ–ç‚¹å‡»å†å²è®°å½•ä¸­çš„å›¾ç‰‡è¿›è¡Œæ›´å¤šæ“ä½œã€‚",
                position: "left"
            },
            {
                element: "#historySection",
                title: "7. å†å²è®°å½•",
                content: "æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡éƒ½ä¼šä¿å­˜åœ¨è¿™é‡Œã€‚ç‚¹å‡»å¯æŸ¥çœ‹è¯¦æƒ…ã€é‡ç”¨æç¤ºè¯æˆ–ç”¨ä½œå‚è€ƒå›¾ã€‚å¼€å§‹åˆ›ä½œå§ï¼",
                position: "top",
                showHidden: true
            }
        ];

        var inpaintingTutorialSteps = [
            {
                element: null,
                title: "æ¬¢è¿ä½¿ç”¨å±€éƒ¨é‡ç»˜",
                content: "å±€éƒ¨é‡ç»˜å¯ä»¥ä¿®å¤å›¾ç‰‡ä¸­çš„å°ç‘•ç–µã€‚ç”¨ç”»ç¬”æ¶‚æŠ¹æƒ³è¦ä¿®æ”¹çš„åŒºåŸŸï¼ŒAI ä¼šé‡æ–°ç»˜åˆ¶è¿™äº›éƒ¨åˆ†ã€‚",
                position: "center"
            },
            {
                element: "#inpaintToolbar",
                title: "1. å·¥å…·æ ",
                content: "è°ƒèŠ‚ç¬”åˆ·å¤§å°ï¼Œé€‰æ‹©ç”»ç¬”æˆ–æ©¡çš®æ“¦ã€‚ç”»ç¬”ç”¨äºæ ‡è®°ä¿®æ”¹åŒºåŸŸï¼Œæ©¡çš®æ“¦ç”¨äºæ’¤é”€æ ‡è®°ã€‚",
                position: "top"
            },
            {
                element: "#editorCanvasContainer",
                title: "2. ç»˜åˆ¶é®ç½©",
                content: "åœ¨å›¾ç‰‡ä¸Šæ¶‚æŠ¹ï¼ˆçº¢è‰²åŒºåŸŸï¼‰ã€‚è¿™äº›åŒºåŸŸä¼šè¢« AI é‡æ–°ç»˜åˆ¶ï¼Œæœªæ¶‚æŠ¹åŒºåŸŸä¿æŒä¸å˜ã€‚",
                position: "bottom"
            },
            {
                element: null,
                title: "3. å®Œæˆæ“ä½œ",
                content: "æ¶‚æŠ¹å®Œæˆåï¼Œç‚¹å‡»å³ä¸Šè§’ç»¿è‰² âœ“ æŒ‰é’®åº”ç”¨é®ç½©ï¼Œæˆ–ç‚¹å‡»çº¢è‰² âœ• æŒ‰é’®å–æ¶ˆã€‚",
                position: "center"
            }
        ];

        var currentStepIndex = 0;
        var isTutorialActive = false;
        var currentTutorialSet = tutorialSteps;

        function initTutorial() {
            if (!localStorage.getItem('bananaDrawTutorialComplete')) {
                // Short delay to ensure loading
                setTimeout(() => startTutorial(), 1000);
            }
        }

        function startTutorial(isSubTutorial = false) {
            isTutorialActive = true;
            currentStepIndex = 0;
            currentTutorialSet = isSubTutorial ? inpaintingTutorialSteps : tutorialSteps;

            document.getElementById('tutorialOverlay').classList.add('active');
            showStep(currentStepIndex);
        }

        function startInpaintingTutorial() {
            if (!localStorage.getItem('bananaDrawInpaintingTutorialComplete')) {
                setTimeout(() => startTutorial(true), 500);
            }
        }

        function nextTutorialStep() {
            if (currentStepIndex < currentTutorialSet.length - 1) {
                currentStepIndex++;
                showStep(currentStepIndex);
            } else {
                endTutorial();
            }
        }

        function showStep(index) {
            const step = currentTutorialSet[index];
            const tooltip = document.getElementById('tutorialTooltip');
            const spotlight = document.getElementById('tutorialSpotlight');
            const titleEl = document.getElementById('tutorialTitle');
            const contentEl = document.getElementById('tutorialContent');
            const badgeEl = document.getElementById('tutorialBadge');
            const nextBtn = document.getElementById('tutorialNextBtn');

            // Update Content
            titleEl.textContent = step.title;
            contentEl.textContent = step.content;
            badgeEl.textContent = `${index + 1}/${currentTutorialSet.length}`;
            nextBtn.textContent = index === currentTutorialSet.length - 1 ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥";

            // Position Logic
            if (!step.element) {
                // Center / Welcome step
                spotlight.style.opacity = '0';
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
                tooltip.classList.add('visible');
            } else {
                const targetEl = document.querySelector(step.element);
                if (targetEl) {
                    // Show hidden elements temporarily for tutorial
                    if (step.showHidden && targetEl.style.display === 'none') {
                        targetEl.style.display = 'block';
                        targetEl.dataset.tutorialHidden = 'true';
                    }

                    // First scroll to element, then position after scroll completes
                    targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Wait for scroll to complete, then position elements
                    setTimeout(() => {
                        const rect = targetEl.getBoundingClientRect();

                        // Set Spotlight
                        spotlight.style.width = (rect.width + 16) + 'px';
                        spotlight.style.height = (rect.height + 16) + 'px';
                        spotlight.style.top = (rect.top - 8) + 'px';
                        spotlight.style.left = (rect.left - 8) + 'px';
                        spotlight.style.opacity = '1';

                        // Set Tooltip Position
                        let top, left;
                        const gap = 20;

                        if (step.position === 'bottom') {
                            top = rect.bottom + gap;
                            left = rect.left + (rect.width / 2) - 160;
                        } else if (step.position === 'top') {
                            top = rect.top - 180 - gap; // Approximate tooltip height
                            left = rect.left + (rect.width / 2) - 160;
                        } else if (step.position === 'right') {
                            top = rect.top;
                            left = rect.right + gap;
                        } else if (step.position === 'left') {
                            top = rect.top;
                            left = rect.left - 320 - gap;
                        } else {
                            top = rect.bottom + gap;
                            left = rect.left;
                        }

                        // Boundary checks
                        if (left < 20) left = 20;
                        if (left + 320 > window.innerWidth) left = window.innerWidth - 340;
                        if (top < 20) top = 20;
                        if (top + 200 > window.innerHeight) top = window.innerHeight - 220;

                        tooltip.style.transform = 'none';
                        tooltip.style.top = top + 'px';
                        tooltip.style.left = left + 'px';
                        tooltip.classList.add('visible');
                    }, 400); // Wait for scroll animation
                } else {
                    // Element not found - skip or fallback
                    console.warn('Tutorial element not found:', step.element);
                    // center tooltip as fallback
                    spotlight.style.opacity = '0';
                    tooltip.style.top = '50%';
                    tooltip.style.left = '50%';
                    tooltip.style.transform = 'translate(-50%, -50%)';
                    tooltip.classList.add('visible');
                }
            }
        }

        function skipTutorial() {
            endTutorial();
        }

        function endTutorial() {
            isTutorialActive = false;
            document.getElementById('tutorialOverlay').classList.remove('active');
            document.getElementById('tutorialTooltip').classList.remove('visible');
            document.getElementById('tutorialSpotlight').style.opacity = '0';

            // Restore hidden elements that were shown for tutorial
            document.querySelectorAll('[data-tutorial-hidden="true"]').forEach(el => {
                el.style.display = 'none';
                delete el.dataset.tutorialHidden;
            });

            if (currentTutorialSet === tutorialSteps) {
                localStorage.setItem('bananaDrawTutorialComplete', 'true');
            } else {
                localStorage.setItem('bananaDrawInpaintingTutorialComplete', 'true');
            }
        }

        // Initialize
        window.addEventListener('load', initTutorial);

        function switchProvider() {
            const provider = document.getElementById('apiProvider').value;
            const modelGroup = document.getElementById('modelGroup');
            const endpointGroup = document.getElementById('endpointGroup');
            const advancedToggle = document.querySelector('.advanced-toggle');
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyHint = document.getElementById('apiKeyHint');
            const referenceImageGroup = document.getElementById('referenceImageGroup');
            const providerNote = document.getElementById('providerNote');

            const imageCountGroup = document.getElementById('imageCountGroup');
            const temperatureGroup = document.getElementById('temperatureGroup');
            const safetyGroup = document.getElementById('safetyGroup');

            // Replicate specific fields
            const widthGroup = document.getElementById('widthGroup');
            const heightGroup = document.getElementById('heightGroup');
            const stepsGroup = document.getElementById('stepsGroup');
            const cfgGroup = document.getElementById('cfgGroup');

            const resolutionHint = document.getElementById('resolutionHint');
            const aspectRatioGroup = document.getElementById('aspectRatioGroup');

            if (provider === 'gemini') {
                modelGroup.style.display = 'none';
                endpointGroup.style.display = 'none';

                // Show Gemini controls
                aspectRatioGroup.style.display = 'block';
                // Gemini 2.5 Flash Image ç›®å‰ä¸æ”¯æŒå¤šå›¾ç”Ÿæˆï¼Œéšè—è¯¥é€‰é¡¹
                imageCountGroup.style.display = 'none';
                // æ˜¾ç¤ºåˆ†è¾¨ç‡æç¤º
                if (resolutionHint) resolutionHint.style.display = 'block';
                updateResolutionHint();

                // Advanced Toggle visible, but content filtered
                advancedToggle.style.display = 'flex';

                // Show/Hide inside Advanced Settings
                document.getElementById('advancedSettings').classList.remove('show');
                widthGroup.style.display = 'none';
                heightGroup.style.display = 'none';
                stepsGroup.style.display = 'none';
                cfgGroup.style.display = 'none';
                temperatureGroup.style.display = 'block';
                safetyGroup.style.display = 'block';

                apiKeyInput.placeholder = 'è¾“å…¥ä½ çš„ Google AI API Key';
                apiKeyHint.innerHTML = 'è·å– Key: <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--text-primary);">aistudio.google.com/apikey</a>';
                // Gemini æ”¯æŒå›¾ç”Ÿå›¾
                referenceImageGroup.style.display = 'block';
                providerNote.style.display = 'block';
            } else if (provider === 'replicate') {
                modelGroup.style.display = 'block';
                endpointGroup.style.display = 'none';
                // éšè—åˆ†è¾¨ç‡æç¤ºï¼ˆReplicateä½¿ç”¨å®½åº¦/é«˜åº¦ï¼‰
                if (resolutionHint) resolutionHint.style.display = 'none';
                aspectRatioGroup.style.display = 'none';
                imageCountGroup.style.display = 'none';

                advancedToggle.style.display = 'flex';

                widthGroup.style.display = 'block';
                heightGroup.style.display = 'block';
                stepsGroup.style.display = 'block';
                cfgGroup.style.display = 'block';
                temperatureGroup.style.display = 'none';
                safetyGroup.style.display = 'none';

                apiKeyInput.placeholder = 'è¾“å…¥ä½ çš„ Replicate API Key';
                apiKeyHint.innerHTML = 'è·å– Key: <a href="https://replicate.com/account/api-tokens" target="_blank" style="color: var(--text-primary);">replicate.com/account/api-tokens</a>';
                referenceImageGroup.style.display = 'block';
                providerNote.style.display = 'none';
            } else {
                modelGroup.style.display = 'none';
                endpointGroup.style.display = 'block';
                aspectRatioGroup.style.display = 'none';
                imageCountGroup.style.display = 'none';
                // éšè—åˆ†è¾¨ç‡æç¤ºï¼ˆè‡ªå®šä¹‰ç«¯ç‚¹ä½¿ç”¨å®½åº¦/é«˜åº¦ï¼‰
                if (resolutionHint) resolutionHint.style.display = 'none';

                advancedToggle.style.display = 'flex';

                widthGroup.style.display = 'block';
                heightGroup.style.display = 'block';
                stepsGroup.style.display = 'block';
                cfgGroup.style.display = 'block';
                temperatureGroup.style.display = 'none';
                safetyGroup.style.display = 'none';

                apiKeyInput.placeholder = 'API Key (å¯é€‰ï¼Œè§†ç«¯ç‚¹è¦æ±‚)';
                apiKeyHint.innerHTML = 'ä½¿ç”¨æœ¬åœ° Stable Diffusion WebUI æ—¶ï¼ŒAPI Key é€šå¸¸ä¸éœ€è¦';
                referenceImageGroup.style.display = 'block';
                providerNote.style.display = 'none';
            }
            localStorage.setItem('ai-draw-provider', provider);
            updateApiKeyUI();
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const btn = document.querySelector('.toggle-visibility');
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
            }
        }
        function toggleAdvanced() { const settings = document.getElementById('advancedSettings'); const icon = document.getElementById('advancedIcon'); settings.classList.toggle('show'); icon.textContent = settings.classList.contains('show') ? 'â–¼' : 'â–¶'; }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        // Enhanced Toast System
        function showStatus(message, type = 'info', action = null) {
            let statusEl = document.getElementById('statusMessage');

            // Create if not exists (though it should exist from basic html)
            if (!statusEl) {
                statusEl = document.createElement('div');
                statusEl.id = 'statusMessage';
                document.body.appendChild(statusEl);
            }

            // Clear previous timeout
            if (statusEl.timeoutId) clearTimeout(statusEl.timeoutId);

            // New Content
            statusEl.innerHTML = `<span>${message}</span>`;

            if (action) {
                const btn = document.createElement('button');
                btn.textContent = action.text;
                btn.className = 'status-action-btn';
                btn.style.cssText = 'margin-left:10px; background:var(--accent-blue); color:white; border:none; padding:4px 12px; border-radius:20px; font-size:12px; cursor:pointer;';
                btn.onclick = () => {
                    action.callback();
                    statusEl.classList.remove('show');
                };
                statusEl.appendChild(btn);
            }

            statusEl.className = 'status-message show ' + type;

            // Hide after 3s (or 5s if action)
            const duration = action ? 5000 : 3000;
            statusEl.timeoutId = setTimeout(() => {
                statusEl.classList.remove('show');
            }, duration);
        }
        function hideStatus() { document.getElementById('statusMessage').classList.remove('show'); }

        async function generateImage() {
            const provider = document.getElementById('apiProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const prompt = document.getElementById('prompt').value.trim();
            const negativePrompt = document.getElementById('negativePrompt').value.trim();
            const width = parseInt(document.getElementById('width').value);
            const height = parseInt(document.getElementById('height').value);
            const steps = parseInt(document.getElementById('steps').value);
            const cfgScale = parseFloat(document.getElementById('cfgScale').value);
            const seed = parseInt(document.getElementById('seed').value);
            const hasServerKey = serverApiKeyStatus[provider];
            if ((provider === 'gemini' || provider === 'replicate') && !apiKey && !hasServerKey) { showStatus(`è¯·è¾“å…¥ ${provider === 'gemini' ? 'Gemini' : 'Replicate'} API Keyï¼Œæˆ–ç™»å½•åä¿å­˜ Key åˆ°è´¦æˆ·`, 'error'); return; }
            if (provider === 'custom' && !document.getElementById('endpoint').value.trim()) { showStatus('è¯·è¾“å…¥ API ç«¯ç‚¹', 'error'); return; }
            if (!prompt) { showStatus('è¯·è¾“å…¥æç¤ºè¯', 'error'); return; }
            if (apiKey && !hasServerKey) localStorage.setItem('ai-draw-api-key', apiKey);
            if (provider === 'custom') localStorage.setItem('ai-draw-endpoint', document.getElementById('endpoint').value.trim());
            const btn = document.getElementById('generateBtn'); const loadingOverlay = document.getElementById('loadingOverlay'); const loadingText = loadingOverlay.querySelector('.loading-text'); const placeholder = document.getElementById('placeholder'); const resultArea = document.getElementById('resultArea');
            const resultContainer = document.getElementById('resultContainer');

            btn.disabled = true; btn.innerHTML = 'â³ ç”Ÿæˆä¸­...'; loadingOverlay.style.display = 'flex'; placeholder.style.display = 'none'; resultContainer.style.display = 'none'; resultContainer.innerHTML = '';

            // Reset Result Area State
            resultArea.classList.remove('has-image', 'is-single', 'is-grid');
            document.getElementById('resultActions').style.display = 'none';

            hideStatus();

            try {
                let resultData = null;
                if (provider === 'gemini') resultData = await generateWithGemini(apiKey, prompt, negativePrompt, loadingText);
                else if (provider === 'replicate') resultData = await generateWithReplicate(apiKey, prompt, negativePrompt, width, height, steps, cfgScale, seed, loadingText);
                else resultData = await generateWithCustomEndpoint(apiKey, prompt, negativePrompt, width, height, steps, cfgScale, seed, loadingText);

                if (!resultData) throw new Error('æœªèƒ½è·å–åˆ°å›¾ç‰‡');

                // Normalizing resultData to array
                const images = Array.isArray(resultData) ? resultData : [resultData];

                if (images.length === 0) throw new Error('æœªèƒ½è·å–åˆ°å›¾ç‰‡');

                resultContainer.style.display = 'flex';
                resultArea.classList.add('has-image');

                if (images.length === 1) {
                    resultContainer.className = 'result-image-container'; // Single view
                    resultArea.classList.add('is-single'); // Add Adaptive Frame Class
                    resultArea.classList.remove('is-grid');

                    const img = document.createElement('img');
                    img.src = images[0];
                    img.className = 'result-image';
                    img.id = 'resultImage'; // Restore ID for download function compatibility
                    img.onclick = () => openLightbox(0); // Open first item in lightbox (careful with index since array changes)
                    resultContainer.appendChild(img);
                } else {
                    resultContainer.className = 'result-image-container result-image-grid'; // Grid view
                    resultArea.classList.remove('is-single');
                    resultArea.classList.add('is-grid'); // Add Grid Frame Class

                    images.forEach((src, idx) => {
                        const img = document.createElement('img');
                        img.src = src;
                        img.className = 'result-image';
                        img.onclick = () => {
                            // Find index in history?
                            // For fresh generation, we simply open lightbox with simplified view or just fallback
                            const win = window.open();
                            win.document.write('<img src="' + src + '" style="max-width:100%">');
                        };
                        resultContainer.appendChild(img);
                    });
                    const hiddenMain = document.createElement('img');
                    hiddenMain.id = 'resultImage';
                    hiddenMain.src = images[0];
                    hiddenMain.style.display = 'none';
                    resultContainer.appendChild(hiddenMain);
                }

                document.getElementById('resultActions').style.display = 'flex';

                // Add to history with params
                const params = {
                    aspectRatio: document.getElementById('aspectRatio').value,
                    steps: document.getElementById('steps').value,
                    cfg: document.getElementById('cfgScale').value,
                    model: provider,
                    seed: document.getElementById('seed').value
                };

                // Add all images to history locally
                // Reverse iterate to keep order in unshift
                for (let i = images.length - 1; i >= 0; i--) {
                    addToHistory(images[i], prompt, currentReferenceId, params);
                }

                showStatus('å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) { console.error('ç”Ÿæˆå¤±è´¥:', error); showStatus(`ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error'); placeholder.style.display = 'block'; }
            finally { btn.disabled = false; btn.innerHTML = 'ç”Ÿæˆå›¾ç‰‡'; loadingOverlay.style.display = 'none'; }
        }

        async function generateWithGemini(apiKey, prompt, negativePrompt, loadingText) {
            loadingText.textContent = referenceImagesData.length > 0 ? 'æ­£åœ¨è¿›è¡Œå›¾ç”Ÿå›¾ (å¤šæ¨¡æ€)...' : 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            const headers = { 'Content-Type': 'application/json' }; if (userToken) headers['Authorization'] = `Bearer ${userToken}`;

            const aspectRatio = document.getElementById('aspectRatio').value;
            const temperature = document.getElementById('temperature').value;
            const safetySettings = document.getElementById('safetySettings').value;

            // Gemini æ”¯æŒå¤šæ¨¡æ€å›¾ç”Ÿå›¾ (Array of images)
            // Note: Gemini Inpainting is not standard, mainly edit via prompt with images. 
            // We pass the mask in the object, assuming backend or model handles it if capable.
            const response = await fetch('/api/image/gemini', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    apiKey: apiKey || undefined,
                    prompt: prompt,
                    negativePrompt: negativePrompt || undefined,
                    referenceImages: referenceImagesData.length > 0 ? referenceImagesData : undefined,
                    aspectRatio,
                    temperature,
                    safetySettings
                })
            });
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥');
            if (result.images && result.images.length > 0) return result.images; // Return Array
            throw new Error('æœªèƒ½è·å–åˆ°å›¾ç‰‡');
        }

        async function generateWithReplicate(apiKey, prompt, negativePrompt, width, height, steps, cfgScale, seed, loadingText) {
            const modelKey = document.getElementById('modelKey').value; loadingText.textContent = 'æ­£åœ¨æäº¤ç”Ÿæˆä»»åŠ¡...';
            const input = { prompt: prompt, width: width, height: height, num_inference_steps: steps, guidance_scale: cfgScale };
            if (negativePrompt) input.negative_prompt = negativePrompt;
            if (seed !== -1) input.seed = seed;

            // Check for Reference Image & Mask
            if (referenceImagesData.length > 0) {
                // Replicate Inpainting logic usually requires: image (init) + mask
                // We take the first one for simplicity
                const ref = referenceImagesData[0];
                input.image = ref.preview; // Base64
                if (ref.mask) {
                    input.mask = ref.mask; // Base64
                    // Some models use 'mask_image'
                    input.mask_image = ref.mask;
                }
            }
            const headers = { 'Content-Type': 'application/json' }; if (userToken) headers['Authorization'] = `Bearer ${userToken}`;
            const createResponse = await fetch('/api/image/replicate', { method: 'POST', headers: headers, body: JSON.stringify({ apiKey: apiKey || undefined, model: modelKey, input: input }) });
            const createResult = await createResponse.json();
            if (!createResponse.ok || createResult.error) throw new Error(createResult.error || 'æäº¤ä»»åŠ¡å¤±è´¥');
            const predictionId = createResult.id; loadingText.textContent = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            let attempts = 0; const maxAttempts = 60;
            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 2000)); attempts++;
                const statusResponse = await fetch(`/api/image/replicate/${predictionId}`, { headers: { 'X-API-Key': apiKey } });
                const statusResult = await statusResponse.json();
                if (statusResult.status === 'succeeded') { const output = statusResult.output; if (Array.isArray(output) && output.length > 0) return output[0]; else if (typeof output === 'string') return output; throw new Error('æ— æ³•è§£æç”Ÿæˆç»“æœ'); }
                else if (statusResult.status === 'failed') throw new Error(statusResult.error || 'ç”Ÿæˆå¤±è´¥');
                loadingText.textContent = `æ­£åœ¨ç”Ÿæˆå›¾ç‰‡... (${attempts * 2}s)`;
            }
            throw new Error('ç”Ÿæˆè¶…æ—¶ï¼Œè¯·é‡è¯•');
        }

        async function generateWithCustomEndpoint(apiKey, prompt, negativePrompt, width, height, steps, cfgScale, seed, loadingText) {
            const endpoint = document.getElementById('endpoint').value.trim(); loadingText.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
            const body = { prompt: prompt, negative_prompt: negativePrompt || '', width: width, height: height, steps: steps, cfg_scale: cfgScale, seed: seed === -1 ? -1 : seed };

            // Check for Reference Image & Mask (SD WebUI API structure)
            if (referenceImagesData.length > 0) {
                const ref = referenceImagesData[0];
                body.init_images = [ref.base64]; // SD WebUI expects array of base64 strings (no data header usually, but depends on proxy)
                // Or just pass the full dataURL if proxy handles it. Let's assume proxy handles standard SD args.
                // Actually our helper has full dataURL in .preview, and .base64 without header? 
                // compressImageUrl returns dataURL. 
                // Let's use the .preview (dataURL) as safe bet, or .base64 if SD requires raw. 
                // Let's check logic: useAsReference sets { base64: b64, mimeType: mime, preview: ... }

                body.init_images = [ref.preview];

                if (ref.mask) {
                    body.mask = ref.mask;
                    body.inpainting_fill = 1; // Default fill mode (original)
                }
            }
            const response = await fetch('/api/image/proxy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ endpoint: endpoint, apiKey: apiKey || undefined, body: body }) });
            const result = await response.json();
            if (!response.ok || result.error) throw new Error(result.error || 'è¯·æ±‚å¤±è´¥');
            if (result.images && result.images.length > 0) { const base64 = result.images[0]; return `data:image/png;base64,${base64}`; }
            if (result.image) { const img = result.image; return img.startsWith('data:') ? img : `data:image/png;base64,${img}`; }
            if (result.output) return result.output;
            throw new Error('æ— æ³•è§£æå“åº”æ ¼å¼');
        }

        async function downloadImage() {
            const img = document.getElementById('resultImage'); if (!img.src) return;
            try {
                if (img.src.startsWith('http')) { const response = await fetch(img.src); const blob = await response.blob(); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = `ai-draw-${Date.now()}.png`; link.href = url; link.click(); URL.revokeObjectURL(url); }
                else { const link = document.createElement('a'); link.download = `ai-draw-${Date.now()}.png`; link.href = img.src; link.click(); }
            } catch (e) { window.open(img.src, '_blank'); }
        }
        function copyPrompt() { const prompt = document.getElementById('prompt').value; navigator.clipboard.writeText(prompt).then(() => { showStatus('æç¤ºè¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success'); setTimeout(hideStatus, 2000); }); }
        function addToHistory(imageSrc, prompt, parentId = null, params = {}) {
            try {
                if (!imageSrc || !prompt) {
                    console.error('Missing image details');
                    return null;
                }
                const newItem = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    image: imageSrc,
                    prompt: prompt,
                    parentId: parentId || null,
                    params: params,
                    time: Date.now()
                };

                // Ensure imageHistory is an array
                if (!Array.isArray(imageHistory)) {
                    imageHistory = [];
                }

                imageHistory.unshift(newItem);
                // å¢åŠ é™åˆ¶åˆ°50æ¡ï¼Œå¹¶æ™ºèƒ½ä¿ç•™æœ‰çˆ¶å­å…³ç³»çš„è®°å½•
                if (imageHistory.length > 50) {
                    imageHistory = pruneHistoryPreservingRelations(imageHistory, 50);
                }

                // Only save to localStorage if not server-backed? 
                // Mixed mode: We always save to local for cache, but maybe differentiate
                // For now, simple localStorage sync
                if (!newItem.isServer) {
                    localStorage.setItem('ai-draw-history', JSON.stringify(imageHistory));
                }

                // Render update (Synchronous for immediate feedback)
                renderHistory();

                // Scroll history section into view if off-screen
                const section = document.getElementById('historySection');
                if (section) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }

                return newItem.id;
            } catch (e) {
                console.error('Error adding to history:', e);
                showStatus('ä¿å­˜å†å²è®°å½•å¤±è´¥: ' + e.message, 'error');
                return null;
            }
        }

        // æ™ºèƒ½åˆ é™¤å†å²è®°å½•ï¼Œä¿ç•™æœ‰çˆ¶å­å…³ç³»çš„è®°å½•
        function pruneHistoryPreservingRelations(history, maxCount) {
            if (history.length <= maxCount) return history;

            // æ”¶é›†æ‰€æœ‰è¢«å¼•ç”¨çš„çˆ¶èŠ‚ç‚¹ID
            const referencedParentIds = new Set();
            history.forEach(item => {
                if (item.parentId) {
                    referencedParentIds.add(item.parentId);
                }
            });

            // ä»åå¾€å‰åˆ é™¤ï¼Œä½†è·³è¿‡è¢«å¼•ç”¨çš„çˆ¶èŠ‚ç‚¹
            const result = [];
            const toRemove = history.length - maxCount;
            let removed = 0;

            // å…ˆä¿ç•™å‰é¢çš„è®°å½•ï¼ˆè¾ƒæ–°çš„ï¼‰
            for (let i = 0; i < history.length; i++) {
                const item = history[i];
                // å¦‚æœå·²ç»åˆ é™¤å¤Ÿäº†ï¼Œæˆ–è€…è¿™ä¸ªèŠ‚ç‚¹è¢«å…¶ä»–èŠ‚ç‚¹å¼•ç”¨ï¼Œä¿ç•™å®ƒ
                if (removed >= toRemove || referencedParentIds.has(item.id)) {
                    result.push(item);
                } else if (i >= history.length - toRemove) {
                    // ä»æœ«å°¾åˆ é™¤
                    removed++;
                } else {
                    result.push(item);
                }
            }

            return result.slice(0, maxCount);
        }


        function switchHistoryView(mode) {
            currentViewMode = mode;

            // Update UI buttons
            document.getElementById('viewBtnGrid').classList.toggle('active', mode === 'grid');
            document.getElementById('viewBtnTree').classList.toggle('active', mode === 'tree');

            // Update Container Visibility
            const grid = document.getElementById('historyGrid');
            const tree = document.getElementById('historyTreeView');

            if (mode === 'grid') {
                grid.style.display = 'block'; // Use block for masonry
                tree.style.display = 'none';
                renderHistory(); // Re-render grid
            } else {
                grid.style.display = 'none';
                tree.style.display = 'flex'; // Scale to content
                renderTreeView();
            }
        }

        function renderHistory() {
            const section = document.getElementById('historySection');
            const grid = document.getElementById('historyGrid');
            const tree = document.getElementById('historyTreeView');

            if (imageHistory.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            if (currentViewMode === 'tree') {
                grid.style.display = 'none';
                tree.style.display = 'flex';
                renderTreeView();
                return;
            }

            tree.style.display = 'none';

            // Build HTML content FIRST
            const htmlContent = imageHistory.map((item, index) => {
                const isReference = currentReferenceId === item.id;
                return `
                    <div class="history-item masonry-item ${isReference ? 'is-reference' : ''}" onclick="openLightbox(${index})">
                        ${item.parentId ? '<span class="parent-indicator">å›¾ç”Ÿå›¾</span>' : ''}
                        <img src="${escapeHtml(item.image)}" alt="å†å²å›¾ç‰‡" loading="lazy">
                        <div class="overlay">
                            <button class="overlay-btn" onclick="event.stopPropagation(); useAsReference(${index})">
                                ç”¨ä½œå‚è€ƒ
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Update innerHTML BEFORE showing
            grid.innerHTML = htmlContent;
            grid.className = 'history-grid masonry-grid';

            // Force reflow then show
            void grid.offsetHeight;
            grid.style.display = 'block';
        }

        // Tree View Logic
        function renderTreeView() {
            const container = document.getElementById('historyTreeView');
            if (!container) return;

            try {
                // Build Tree Data Structure
                const roots = buildTreeStructure(imageHistory);

                if (roots.length === 0 && imageHistory.length > 0) {
                    // Fallback if tree build fails
                    console.error('Tree build returned empty roots despite history');
                    container.innerHTML = '<div style="color:white; padding:20px;">æ„å»ºæ ‘çŠ¶å›¾å¤±è´¥ï¼Œè¯·åˆ‡æ¢å›ç½‘æ ¼è§†å›¾</div>';
                    return;
                }

                // Recursive Render
                container.innerHTML = roots.map(node => renderTreeNode(node)).join('');

                // æ¸²æŸ“å®Œæˆåæ·»åŠ æ°´å¹³è¿æ¥çº¿
                requestAnimationFrame(() => addHorizontalConnectors(container));
            } catch (e) {
                console.error('Render tree view error:', e);
                container.innerHTML = `<div style="color:white; padding:20px;">æ¸²æŸ“é”™è¯¯: ${e.message}</div>`;
            }
        }

        // æ·»åŠ æ°´å¹³è¿æ¥çº¿
        function addHorizontalConnectors(container) {
            const nodeChildrenList = container.querySelectorAll('.node-children:not(.single-child)');
            nodeChildrenList.forEach(nodeChildren => {
                // ç§»é™¤å·²å­˜åœ¨çš„è¿æ¥çº¿
                const existingConnector = nodeChildren.querySelector('.horizontal-connector');
                if (existingConnector) existingConnector.remove();

                const children = nodeChildren.querySelectorAll(':scope > .tree-node');
                if (children.length < 2) return;

                const firstChild = children[0];
                const lastChild = children[children.length - 1];

                // è®¡ç®—ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªå­èŠ‚ç‚¹çš„ä¸­å¿ƒä½ç½®
                const parentRect = nodeChildren.getBoundingClientRect();
                const firstRect = firstChild.getBoundingClientRect();
                const lastRect = lastChild.getBoundingClientRect();

                const left = firstRect.left + firstRect.width / 2 - parentRect.left;
                const right = lastRect.left + lastRect.width / 2 - parentRect.left;
                const width = right - left;

                // åˆ›å»ºæ°´å¹³è¿æ¥çº¿
                const connector = document.createElement('div');
                connector.className = 'horizontal-connector';
                connector.style.cssText = `
                    position: absolute;
                    top: 15px;
                    left: ${left}px;
                    width: ${width}px;
                    height: 2px;
                    background: rgba(138, 180, 248, 0.6);
                    z-index: 1;
                `;
                nodeChildren.appendChild(connector);
            });
        }

        function buildTreeStructure(history) {
            if (!Array.isArray(history)) return [];

            // Create map of items
            const itemMap = {};
            history.forEach((item, index) => {
                // Attach original index for callbacks and init children array
                if (item && item.id) {
                    itemMap[item.id] = { ...item, originalIndex: index, children: [] };
                }
            });

            const roots = [];

            // Link children to parents
            history.forEach(item => {
                if (!item || !item.id) return;

                const node = itemMap[item.id];
                // Check if parent exists AND is present in curreny history map
                if (item.parentId && itemMap[item.parentId]) {
                    itemMap[item.parentId].children.push(node);
                } else {
                    // It's a root (or parent is missing/too old)
                    roots.push(node);
                }
            });

            return roots;
        }

        function renderTreeNode(node) {
            const isReference = currentReferenceId === node.id;
            const childCount = node.children.length;

            // æ„å»ºå­èŠ‚ç‚¹HTMLï¼Œæ·»åŠ æ°´å¹³è¿æ¥çº¿æ”¯æŒ
            let childrenHtml = '';
            if (childCount > 0) {
                const singleChildClass = childCount === 1 ? 'single-child' : '';
                const childrenContent = node.children.map(child => renderTreeNode(child)).join('');
                childrenHtml = `<div class="node-children ${singleChildClass}">${childrenContent}</div>`;
            }

            return `
                <div class="tree-node">
                    <div class="node-content">
                        <div class="history-item ${isReference ? 'is-reference' : ''}" title="${escapeHtml(node.prompt)}" onclick="openLightbox(${node.originalIndex})">
                            <span class="parent-indicator" style="display: ${node.parentId ? 'block' : 'none'}">å›¾ç”Ÿå›¾</span>
                            <img src="${escapeHtml(node.image)}" alt="å†å²å›¾ç‰‡" onerror="this.parentElement.style.display='none'">
                            <div class="overlay">
                                <button class="overlay-btn" onclick="event.stopPropagation(); useAsReference(${node.originalIndex})">ç”¨ä½œå‚è€ƒ</button>
                            </div>
                        </div>
                    </div>
                    ${childrenHtml}
                </div>
            `;
        }

        async function useAsReference(index) {
            const item = imageHistory[index];
            if (!item) return;

            showStatus('æ­£åœ¨å¤„ç†å‚è€ƒå›¾...', 'info');

            try {
                // Use Image loading to handle CORS and compression in one go
                const compressedDataUrl = await compressImageUrl(item.image);

                const matches = compressedDataUrl.match(/^data:(.+);base64,(.+)$/);
                if (!matches) throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®');

                const mime = matches[1];
                const b64 = matches[2];

                referenceImageData = { base64: b64, mimeType: mime };
                currentReferenceId = item.id;

                // Update reference images array and render previews
                referenceImagesData = [{ base64: b64, mimeType: mime, preview: compressedDataUrl }];
                renderReferencePreviews();

                renderHistory();
                showStatus('å·²è®¾å®šå‚è€ƒå›¾', 'success');
                setTimeout(hideStatus, 2000);

                document.getElementById('prompt').scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (e) {
                console.error('Failed to process reference image', e);
                if (e.name === 'SecurityError' || e.message.includes('Tainted')) {
                    showStatus('æ— æ³•ä½¿ç”¨æ­¤å›¾ç‰‡ä½œä¸ºå‚è€ƒï¼ˆè·¨åŸŸé™åˆ¶ï¼‰ã€‚è¯·å°è¯•å…ˆä¸‹è½½å†ä¸Šä¼ ã€‚', 'error');
                } else {
                    showStatus('åŠ è½½å‚è€ƒå›¾å¤±è´¥: ' + e.message, 'error');
                }
            }
        }

        function compressImageUrl(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                // Important: Request CORS permission to read pixels
                img.crossOrigin = 'Anonymous';

                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Resize to max 1024x1024
                        const maxSize = 1024;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = Math.round(height * (maxSize / width));
                                width = maxSize;
                            } else {
                                width = Math.round(width * (maxSize / height));
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // This will throw SecurityError if CORS failed despite crossOrigin setting
                        // (i.e. server did not send Access-Control-Allow-Origin)
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    } catch (err) {
                        reject(err);
                    }
                };

                img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                img.src = src;
            });
        }

        function loadFromHistory(index) {
            const item = imageHistory[index];
            if (!item) return;
            document.getElementById('prompt').value = item.prompt;
            const resultImage = document.getElementById('resultImage');
            resultImage.src = item.image;
            resultImage.style.display = 'block';
            document.getElementById('placeholder').style.display = 'none';
            document.getElementById('resultArea').classList.add('has-image');
            document.getElementById('resultActions').style.display = 'flex';
        }
    </script>

    <!-- Inpainting Editor Modal -->
    <div id="inpaintingModal" class="lightbox-overlay"
        style="display: none; padding: 20px; background: rgba(13, 13, 18, 0.4) !important;">
        <div class="panel"
            style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: rgba(20, 20, 30, 0.2); backdrop-filter: saturate(180%) blur(50px); -webkit-backdrop-filter: saturate(180%) blur(50px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 40px 80px rgba(0, 0, 0, 0.6);">
            <!-- Floating Action Buttons -->
            <div style="position: absolute; top: 20px; right: 20px; z-index: 10020; display: flex; gap: 12px;">
                <button class="btn" id="inpaintCancelBtn" onclick="closeInpaintingModal()"
                    style="position: relative; z-index: 10020; pointer-events: auto !important; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; padding: 0; border-radius: 50%; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); background: rgba(239, 68, 68, 0.9); border: 2px solid rgba(255,255,255,0.3); color: white;"
                    title="å–æ¶ˆ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
                <button class="btn" onclick="saveInpaintingMask()"
                    style="display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; padding: 0; border-radius: 50%; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);"
                    title="åº”ç”¨é®ç½©">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 6 9 17l-5-5"></path>
                    </svg>
                </button>
            </div>

            <!-- Canvas Area -->
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px), radial-gradient(circle at 50% 50%, var(--glow-color), transparent 70%); background-size: 30px 30px, 30px 30px, 100% 100%; background-position: center; position: relative; overflow: hidden;"
                id="editorCanvasContainer">
                <div style="position: relative; display: inline-block; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
                    <img id="editorBaseImage"
                        style="display: block; max-width: 90vw; max-height: 75vh; object-fit: contain; pointer-events: none; user-select: none;">
                    <canvas id="inpaintingCanvas"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; touch-action: none;"></canvas>
                </div>
            </div>

            <div id="inpaintToolbar" class="toolbar"
                style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; align-items: center; background: var(--card-bg); padding: 12px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.3), 0 0 20px var(--glow-color); backdrop-filter: saturate(180%) blur(30px); -webkit-backdrop-filter: saturate(180%) blur(30px); cursor: move; user-select: none;">
                <div class="tool-group"
                    style="display: flex; align-items: center; gap: 12px; color: var(--text-primary); border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px;">
                    <span style="font-size: 0.9rem; opacity: 0.7;">ç¬”åˆ·</span>
                    <input type="range" id="brushSize" min="5" max="150" value="40"
                        style="width: 100px; accent-color: var(--accent-blue);">
                    <span id="brushSizeLabel"
                        style="width: 45px; text-align: right; font-size: 0.85rem; opacity: 0.8;">40px</span>
                </div>

                <div class="tool-group" style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="brushBtn" onclick="setInpaintingTool('brush')"
                        style="display: flex; justify-content: center; align-items: center; padding: 0; border-radius: 50%; width: 44px; height: 44px;"
                        title="ç”»ç¬”">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M18.37 2.63 14 7l-1.59-1.59a2 2 0 0 0-2.82 0L8 7l9 9 1.59-1.59a2 2 0 0 0 0-2.82L17 10l4.37-4.37a2.12 2.12 0 1 0-3-3Z">
                            </path>
                            <path d="M9 8c-2 3-4 3.5-7 4l8 10c2-1 6-5 6-7"></path>
                            <path d="M14.5 17.5 4.5 15"></path>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" id="eraserBtn" onclick="setInpaintingTool('eraser')"
                        style="display: flex; justify-content: center; align-items: center; padding: 0; border-radius: 50%; width: 44px; height: 44px;"
                        title="æ©¡çš®æ“¦">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21">
                            </path>
                            <path d="M22 21H7"></path>
                            <path d="m5 11 9 9"></path>
                        </svg>
                    </button>
                    <button class="btn btn-secondary" onclick="clearInpaintingMask()"
                        style="display: flex; justify-content: center; align-items: center; padding: 0; border-radius: 50%; width: 44px; height: 44px; color: #ff6b6b;"
                        title="æ¸…ç©ºç”»å¸ƒ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inpainting State
        let currentMaskData = null;
        let isInpaintingEditorOpen = false;
        let inpaintingCtx = null;
        let isDrawingMask = false;
        let isEraserMode = false;
        let editorBrushSize = 40;

        function openInpaintingEditor(imageSrc) {
            const modal = document.getElementById('inpaintingModal');
            const baseImg = document.getElementById('editorBaseImage');
            const canvas = document.getElementById('inpaintingCanvas');

            // Show modal with animation
            modal.style.display = 'flex';
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
            isInpaintingEditorOpen = true;

            // Generate canvas context if not exists
            if (!inpaintingCtx) {
                inpaintingCtx = canvas.getContext('2d');
                setupCanvasEvents(canvas);
            }

            // Load Image
            baseImg.onload = () => {
                // Resize canvas to match displayed image dimensions
                const rect = baseImg.getBoundingClientRect();
                canvas.width = baseImg.naturalWidth;
                canvas.height = baseImg.naturalHeight;

                // Match visual size
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';

                inpaintingCtx.lineCap = 'round';
                inpaintingCtx.lineJoin = 'round';

                // Trigger tutorial after layout is ready
                startInpaintingTutorial();
            };
            baseImg.src = imageSrc;

            // Clear previous mask unless we want to allow editing existing one (todo)
            clearInpaintingMask();
        }

        function closeInpaintingModal() {
            // End tutorial if active
            if (isTutorialActive && currentTutorialSet === inpaintingTutorialSteps) {
                endTutorial();
            }

            const modal = document.getElementById('inpaintingModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 400); // Match CSS transition duration
            isInpaintingEditorOpen = false;
        }

        function setupCanvasEvents(canvas) {
            canvas.addEventListener('mousedown', startDrawingMask);
            canvas.addEventListener('mousemove', drawMask);
            canvas.addEventListener('mouseup', stopDrawingMask);
            canvas.addEventListener('mouseout', stopDrawingMask);

            const brushInput = document.getElementById('brushSize');
            const updateBrushLabel = () => {
                editorBrushSize = parseInt(brushInput.value);
                const label = document.getElementById('brushSizeLabel');
                if (label) {
                    label.textContent = editorBrushSize + 'px';
                }
            };

            brushInput.addEventListener('input', updateBrushLabel);
            // Init label
            updateBrushLabel();

            // Setup toolbar dragging
            setupToolbarDrag();
        }

        function setupToolbarDrag() {
            const toolbar = document.getElementById('inpaintToolbar');
            if (!toolbar) return;

            let isDragging = false;
            let hasMoved = false;
            let offsetX, offsetY;
            let initialStyles = {};

            toolbar.addEventListener('mousedown', (e) => {
                // Only start drag if clicking on toolbar itself or non-interactive elements
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SVG' || e.target.tagName === 'path') return;

                isDragging = true;
                hasMoved = false;

                const toolbarRect = toolbar.getBoundingClientRect();

                // Calculate offset from mouse to toolbar corner
                offsetX = e.clientX - toolbarRect.left;
                offsetY = e.clientY - toolbarRect.top;

                // Store initial styles to restore if no movement
                initialStyles = {
                    left: toolbar.style.left,
                    top: toolbar.style.top,
                    bottom: toolbar.style.bottom,
                    transform: toolbar.style.transform
                };

                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                // Apply position style changes only on first move
                if (!hasMoved) {
                    hasMoved = true;
                    toolbar.style.bottom = 'auto';
                    toolbar.style.transform = 'none';
                }

                const parent = toolbar.offsetParent || document.body;
                const parentRect = parent.getBoundingClientRect();

                // Calculate new position relative to parent
                const newLeft = e.clientX - parentRect.left - offsetX;
                const newTop = e.clientY - parentRect.top - offsetY;

                toolbar.style.left = newLeft + 'px';
                toolbar.style.top = newTop + 'px';
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function startDrawingMask(e) {
            isDrawingMask = true;
            drawMask(e);
        }

        function drawMask(e) {
            if (!isDrawingMask) return;

            const canvas = document.getElementById('inpaintingCanvas');
            const rect = canvas.getBoundingClientRect();

            // Map client coords to canvas internal coords
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            inpaintingCtx.lineWidth = editorBrushSize * scaleX; // Adjust brush size by scale

            if (isEraserMode) {
                inpaintingCtx.globalCompositeOperation = 'destination-out';
            } else {
                inpaintingCtx.globalCompositeOperation = 'source-over';
                inpaintingCtx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            }

            inpaintingCtx.lineTo(x, y);
            inpaintingCtx.stroke();
            inpaintingCtx.beginPath();
            inpaintingCtx.moveTo(x, y);
        }

        function stopDrawingMask() {
            isDrawingMask = false;
            inpaintingCtx.beginPath();
        }

        function setInpaintingTool(tool) {
            isEraserMode = (tool === 'eraser');
            document.getElementById('brushBtn').classList.toggle('active', !isEraserMode);
            document.getElementById('eraserBtn').classList.toggle('active', isEraserMode);

            // Visual feedback
            const activeColor = 'var(--accent-blue)';
            document.getElementById('brushBtn').style.background = !isEraserMode ? activeColor : '';
            document.getElementById('eraserBtn').style.background = isEraserMode ? activeColor : '';
        }

        function clearInpaintingMask() {
            if (inpaintingCtx) {
                const canvas = document.getElementById('inpaintingCanvas');
                inpaintingCtx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function saveInpaintingMask() {
            const canvas = document.getElementById('inpaintingCanvas');

            // Generate Binary Mask
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = canvas.width;
            finalCanvas.height = canvas.height;
            const finalCtx = finalCanvas.getContext('2d');

            // Fill Black
            finalCtx.fillStyle = '#000000';
            finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

            // Draw Strokes
            finalCtx.drawImage(canvas, 0, 0);

            // Threshold to Pure White
            const imageData = finalCtx.getImageData(0, 0, finalCanvas.width, finalCanvas.height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                if (data[i] > 20) { // If visible
                    data[i] = 255; data[i + 1] = 255; data[i + 2] = 255; data[i + 3] = 255;
                } else {
                    data[i] = 0; data[i + 1] = 0; data[i + 2] = 0; data[i + 3] = 255;
                }
            }
            finalCtx.putImageData(imageData, 0, 0);

            // Save Base64
            currentMaskData = finalCanvas.toDataURL('image/png');

            showStatus('å±€éƒ¨é‡ç»˜é®ç½©å·²ä¿å­˜', 'success');
            closeInpaintingModal();

            // Update UI to show mask is active
            updateReferencePreviewUI();
        }

        function updateReferencePreviewUI() {
            // To be called when mask is saved to show an indicator
            const containers = document.querySelectorAll('.upload-preview');
            containers.forEach(div => {
                if (!div.querySelector('.mask-badge')) {
                    // Add visual indicator (logic needs to verify if this image is the one masked)
                    // For simplicity now, we assume single reference image flow for inpainting
                }
            });
        }

    </script>

    <!-- Toast Notification (Outside of any panel to avoid stacking context issues) -->
    <div class="status-message" id="statusMessage"></div>
</body>

</html>